---
title: "Baseline Ranked Variables- High Priority"
author: "Kelsey Dowling"
date: "`r Sys.Date()`"
output:
  pdf_document:
    latex_engine: xelatex
---



This report gives the distribution of all Baseline Survey responses for questions deemed 'high priority'; this includes derived variables. Among the Module 1 and Module 2 responses, if a participant was somehow able to complete both versions of either survey, only the version 2 data is kept.


```{r libraries, include=FALSE}


#  pdf-engine: xelatex
#tinytex::install_tinytex()

library(bigrquery)
library(epiDisplay) ##recommended applied here crosstable, tab1
library(gmodels) ##recommended
library(arsenal)
library(gtsummary)
library(rio)



library(ggplot2)
library(gridExtra)
library(scales)
library(gt)
library(tinytex)
library(data.table) ###to write or read and data management 
library(tidyverse) ###for data management
library(dplyr) ###data management
library(lubridate) ###date time
library(stringr) ###to work on patterns, characters
options(tinytex.verbose = TRUE)

bq_auth()

```




```{r merge1, include=FALSE, warning=FALSE}


#Data Dictionary for column names
dictionary <- rio::import("https://episphere.github.io/conceptGithubActions/aggregate.json",format = "json")
dd <- dplyr::bind_rows(dictionary,.id="CID")
dd <-rbindlist(dictionary,fill=TRUE,use.names=TRUE,idcol="CID")
dd$`Variable Label`[is.na(dd$`Variable Label`)] <- replace_na(dd$'Variable Name')
dd <- as.data.frame.matrix(do.call("rbind",dictionary)) 
dd$CID <- rownames(dd)
#https://shaivyakodan.medium.com/7-useful-r-packages-for-analysis-7f60d28dca98
devtools::install_github("tidyverse/reprex")





## BQ Pull from the participants table just to use for versioning
project <- "nih-nci-dceg-connect-prod-6d04"
billing <- "nih-nci-dceg-connect-prod-6d04" 
recr_M1 <- bq_project_query(project, query="SELECT token,Connect_ID, d_821247024, d_914594314,  d_827220437,d_512820379,
                            d_949302066 , d_517311251  FROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` WHERE  d_821247024='197316935' and d_949302066 ='231311385'")
recr_m1 <- bq_table_download(recr_M1,bigint = "integer64")
cnames <- names(recr_m1)
# Check that it doesn't match any non-number
numbers_only <- function(x) !grepl("\\D", x)
# to check variables in recr_noinact_wl1
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(recr_m1,varname)
  recr_m1[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}




#### Handling participants that somehow completed both Mod1 version 1 and Mod1 version 2

sql_M1_1 <- bq_project_query(project, query = "SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v1_JP` WHERE Connect_ID IS NOT NULL")
sql_M1_2 <- bq_project_query(project, query = "SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP` WHERE Connect_ID IS NOT NULL")

M1_V1 <- bq_table_download(sql_M1_1, bigint = "integer64")
M1_V2 <- bq_table_download(sql_M1_2, bigint = "integer64")

# Select matching column names
M1_V1_vars <- colnames(M1_V1)
M1_V2_vars <- colnames(M1_V2)
common_vars <- intersect(M1_V1_vars, M1_V2_vars)

# Subset to common columns
M1_V1_common <- M1_V1[, common_vars]
M1_V2_common <- M1_V2[, common_vars]

# Add version indicator
M1_V1_common$version <- 1
M1_V2_common$version <- 2

# Identify columns with mismatched types
mismatched_cols <- names(M1_V1_common)[sapply(names(M1_V1_common), function(col) {
  class(M1_V1_common[[col]]) != class(M1_V2_common[[col]])
})]

# Convert mismatched columns to character for consistency
M1_V1_common <- M1_V1_common %>%
  mutate(across(all_of(mismatched_cols), as.character))
M1_V2_common <- M1_V2_common %>%
  mutate(across(all_of(mismatched_cols), as.character))

# Combine both versions for participants who completed both
M1_common <- bind_rows(M1_V1_common, M1_V2_common) %>%
  arrange(Connect_ID, desc(version))

# For columns unique to each version
V1_only_vars <- setdiff(M1_V1_vars, common_vars)
V2_only_vars <- setdiff(M1_V2_vars, common_vars)

# Subset each version for unique columns and add version indicator
m1_v1_only <- M1_V1[, c("Connect_ID", V1_only_vars)] %>%
  mutate(version = 1)
m1_v2_only <- M1_V2[, c("Connect_ID", V2_only_vars)] %>%
  mutate(version = 2)

# Combine the unique and common data
m1_common_v1 <- left_join(M1_common, m1_v1_only, by = c("Connect_ID", "version"))
m1_combined_v1v2 <- left_join(m1_common_v1, m1_v2_only, by = c("Connect_ID", "version"))

# Filter for complete cases where specific completion criteria are met
m1_complete <- m1_combined_v1v2 %>%
  filter(Connect_ID %in% recr_m1$Connect_ID[recr_m1$d_949302066 == 231311385]) %>%
  arrange(desc(version))

# Remove duplicates, keeping only the most recent version for each Connect_ID
m1_complete_nodup <- m1_complete[!duplicated(m1_complete$Connect_ID),]

m1_complete_nodup$Connect_ID <- as.numeric(m1_complete_nodup$Connect_ID)


## Define requirements of the data: active or passive,  user profile done, consented, mod1 done, verified
parts <- "SELECT Connect_ID, token,  state_d_934298480, d_564964481, d_795827569, d_544150384,  d_126331570, 
d_536735468, d_663265240, d_878865966, d_684635302, d_167958071, d_949302066 ,  d_976570371, d_914639140, d_311580100, d_100767870
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` 
where Connect_ID IS NOT NULL and (d_512820379='486306141' OR d_512820379='854703046') and d_919254129='353358909' and d_699625233='353358909' and 
d_949302066='231311385'  and d_821247024='197316935'" 


parts_table <- bq_project_query(project, parts)
parts_data <- bq_table_download(parts_table, bigint = "integer64",n_max = Inf, page_size = 10000)

parts_data$Connect_ID <- as.numeric(parts_data$Connect_ID)


merged= left_join(parts_data, m1_complete_nodup, by="Connect_ID")
dim(merged)


data_tib_base <- as_tibble(merged)


knitr::opts_chunk$set(comment = NA)

```


```{r Intro, warning=FALSE, echo=FALSE,  message=FALSE}

base_vars1 <- merged %>% filter(d_949302066==231311385)
base_vars2 <- merged %>% filter(d_536735468==231311385)
base_vars3 <- merged %>% filter(d_976570371==231311385)
base_vars4 <- merged %>% filter(d_663265240==231311385)

cat("Particpants with Module 1 completion: ",dim(base_vars1)[[1]])
cat("Particpants with Module 2 completion: ", dim(base_vars2)[[1]])
cat("Particpants with Module 3 completion: ", dim(base_vars3)[[1]])
cat("Particpants with Module 4 completion: ", dim(base_vars4)[[1]])


```


```{r function1, warning=FALSE, include=FALSE}



##GT TABLE: Questions that all participants asked, update dictionary as new answer options come up
dict <- list("104430631"="No", "353358909"="Yes", "589959753"="A little shorter", "623310018"="A lot shorter", "978204320"= "Grade School(Grades 1-8)", "935502060"="Some High School, No Diploma", "404564707"= "High School Graduate or GED", "432193665"="Some College, No Degree", "890756124"="Technical or Trade School After High School", "766964355"="Associate's Degree", "875342283"="Bachelor's Degree", "598242454"="Advanced Degree", "709650750"="Biological Child", "810290359"="Adopted Child", "509607548"="Step Child","784922042"="Related to me in some other way", "288105839"=" Yes, fraternal twins", "626558982"="Yes, triplets or higher multiple birth", "178420302"="Do not Know", "536341288"="Female", "576796184"="Unknown", "654207589"="Male","555374628"="Full Sibling", "871673221"="Half Sibling, Same Mother",  "198654048"="Half Sibling, Same Father", "807835037"="Other", "274062548"="More than 3 months ago", "958538953"="In the past 3 months", "317567178"="In the past month", "484055234"="In the past year",  "802197176"="More than 1 year ago", "[]"="Answered with number", "[178420302]"="Answered Don't Know", "274062548"="More than 3 months ago","958538953"="In the past 3 months",  "490796638"="Not Flexible","719954633"="Extremely Flexible","929148006"="A Little Flexible","988873962"="Somewhat Flexible", "764708931"="Very flexible","0"="No", "1"="Yes", "536341288"="Female", "218837028"="Woman (New Response)", "983318667"="Man (New Response)"  , "654207589"="Male","805712793"="Genderqueer","486192236"="Non-Binary", "807835037"="Other","873138103"="Transgender Woman","405267600"="Transgender Man", "220083334"="Very Feminine","541300533"="Mostly Feminine","878286618"="Somewhat Feminine","910745276"="Equally feminine and masculine","915528806"="Very masculine","265452386"="Mostly Masculine","510148951"="Somewhat Masculine","271882746"="Straight or heterosexual", "903084185"="Lesbian, gay, or homosexual", "999994434"="Bisexual", "410008111" = "Two-Spirit", "831942158" = "Questioning", "727200870"="Asexual", "854349138"="Pansexual", "832978839"="Mostly Straight", "197935377"="Queer", "410008111"="Two-Spirit", "831942158"="Questioning", "210894509"="No labels",  "209571450" = "35,000-49,000","212249150" = "50,000-74,000","374508062" = "0-9,000", "530094502" = "Error- Unlisted Response Selected", "742032816" = "200,000+", "745561936" = "25,000-34,000","746038746" = "Prefer not to Answer","777814771" = "75,000-99,000","913602274" = "150,000-199,000", "922395188" = "100,000-149,000","976555124" = "10,000-24,000", "670680466"= "Excellent","565881164"= "Very good","719933364"= "Good","131550264"= "Fair","138752522"= "Poor", "146477090"="Type 1", "573635975"="Type 2", "759356722" = "One", "185036360" = "More Than One", "684900118" = "I Don't Commute to Work") 


simple_funct1 <- function(CID, Title){  
  CID_SYM <- rlang::ensym(CID)
  dt_select <- data_tib_base %>%  select(Connect_ID, !!CID_SYM)
  gt_yn <- data_tib_base  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% 
    replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)


  gt_yn %>%  gt::gt()  %>%
  fmt_number(columns = "percentage", decimals = 2) %>% 
    fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md(Title)) %>%
  cols_label(n= md("**N**"), answer = md("**Answer**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = answer,
    )
  ) 
}



#GT table with one filter/skip logic
one_logic_funct <- function(CID, CID_prev, Prev_Answer, Title){  
  CID_SYM <- rlang::ensym(CID)
  CID_SYM_P <- rlang::ensym(CID_prev)
  dt_select <- data_tib_base %>%  filter(!!CID_SYM_P == Prev_Answer) %>%  select(Connect_ID, !!CID_SYM) 
  gt_yn <- dt_select  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% 
    replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)
  
  gt_yn %>%  gt::gt(rowname_col = "row_lab")  %>%
  fmt_number(columns = "percentage", decimals = 2) %>% 
    fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md(Title)) %>%
  cols_label(n= md("**N**"),  answer = md("**Answer**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = answer,
    )
  ) 
}


boxp_funct <- function(CID,Title, Xlab) {
  CID_SYM <- rlang::ensym(CID)
  merged %>% mutate(!!CID_SYM:=as.numeric(!!CID_SYM)) %>%
    filter(!is.na(!!CID_SYM)) %>%
    ggplot(aes(x=!!CID_SYM))+
    xlab(Xlab) + geom_boxplot()+  ggtitle(Title)+
    scale_fill_discrete(name = "Sex at Birth") + 
    scale_y_continuous(labels = scales::number_format(accuracy = 0.01))
}

# #Boxplot
# boxp_funct <- function(CID,Title, Xlab) {
#   CID_SYM <- rlang::ensym(CID)
#   data_tib_base %>% mutate(!!CID_SYM:=as.numeric(!!CID_SYM)) %>%
#     filter(!is.na(!!CID_SYM)) %>%
#     ggplot(aes(x=!!CID_SYM))+
#     xlab(Xlab) + geom_boxplot()+  ggtitle(Title)+
#     theme(axis.text.y=element_blank(),  #remove y axis labels
#         axis.ticks.y=element_blank()  #remove y axis ticks
#         )
# }



# #GT table for siblings
# sib_logic_funct <- function(CID, Sib_Num, Title){  
#   CID_SYM <- rlang::ensym(CID)
#   data_tib_base$D_694265648 <- as.numeric(data_tib_base$D_694265648)
#   dt_select <- data_tib_base %>%  filter(D_694265648 >= Sib_Num) %>%  select(Connect_ID, !!CID_SYM) 
#   gt_yn <- dt_select  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)
#   
#   gt_yn %>%  gt::gt(rowname_col = "row_lab")  %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md(Title)) %>% 
#   cols_label(n= md("**N**"),  answer = md("**Answer**"), percentage = md("**%**")) %>% 
#     grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = answer,
#     )
#   ) 
# }
# 
# 
# #GT table for children
# child_logic_funct <- function(CID, Child_Num, Title){  
#   CID_SYM <- rlang::ensym(CID)
#   data_tib_base$D_446999144 <- as.numeric(data_tib_base$D_446999144)
#   dt_select <- data_tib_base %>%  filter(D_446999144 >= Child_Num) %>%  select(Connect_ID, !!CID_SYM) 
#   gt_yn <- dt_select  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)
#   
#   gt_yn %>%  gt::gt(rowname_col = "row_lab")  %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% 
#     fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md(Title)) %>% 
#   cols_label(n= md("**N**"),  answer = md("**Answer**"), percentage = md("**%**")) %>% 
#     grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = answer,
#     )
#   ) 
# }




# gt_total_func <- function(question_table, var_name, title){ 
#   dt_first_table <- question_table %>%
#     mutate(np = paste0(n, " (", round(percentage, digits = 1), "%)"))
# 
#   summary_row <- dt_first_table %>%
#     summarise(np = paste0(sum(n, na.rm = TRUE), " (100%)"),
#               !!var_name := "Total") %>%
#     select(!!var_name, np)
# 
#   dt_first_table <- dt_first_table %>%
#     select(!!var_name, np)
# 
#   dt_table_summary <- bind_rows(dt_first_table, summary_row)
# 
#   last_row_index <- nrow(dt_table_summary) 
# 
#   dt_table_summary %>%
#     gt::gt() %>%  
#     cols_label(!!var_name := md("**Answer**"), np = md("**N(%)**")) %>% 
#     tab_header(title = md(title)) %>% 
#     tab_options(
#       stub.font.weight = "bold"
#     )  %>%
#     tab_style(
#       style = list(
#         cell_text(weight = "bold")
#       ),
#       locations = cells_body(
#         columns = !!var_name
#       )
#     ) %>%
#     tab_style(
#       style = list(
#         cell_text(indent = px(20))
#       ),
#       locations = cells_body(
#         rows = seq_len(nrow(dt_table_summary)) != nrow(dt_table_summary),
#         columns = vars(!!var_name)
#       )
#     )
#   # for (i in seq_len(nrow(dt_table_summary))) {
#   # if (i != nrow(dt_table_summary)) {
#   #   gt_table <- gt_table %>%
#   #     tab_style(
#   #       style = cell_text(weight = "bold"),
#   #       locations = cells_body(rows = i, columns = vars(!!var_name))
#   #     ) %>%
#   #     tab_style(
#   #       style = cell_text(indent = px(20)),
#   #       locations = cells_body(rows = i, columns = vars(!!var_name))
#   #     )
#   # }
#   # }
# }

# 
# gt_total_func <- function(question_table, var_name, title){ 
#   dt_first_table <- question_table %>%
#     mutate(np = paste0(n, " (", round(percentage, digits = 1), "%)"))
# 
#   summary_row <- dt_first_table %>%
#     summarise(np = paste0(sum(n, na.rm = TRUE), " (100%)"),
#               !!var_name := "Total") %>%
#     select(!!var_name, np)
# 
#   dt_first_table <- dt_first_table %>%
#     select(!!var_name, np)
# 
#   dt_table_summary <- bind_rows(dt_first_table, summary_row)
# 
#   last_row_index <- nrow(dt_table_summary) 
# 
#   gt_table <- dt_table_summary %>%
#     gt::gt() %>%  
#     cols_label(!!var_name := md("**Answer**"), np = md("**N(%)**")) %>% 
#     tab_header(title = md(title)) %>% 
#     tab_options(
#       stub.font.weight = "bold"
#     )  %>%
#     tab_style(
#       style = list(
#         cell_text(weight = "bold")
#       ),
#       locations = cells_body(
#         columns = !!var_name
#       )
#     )
# 
#   for (i in seq_len(nrow(dt_table_summary))) {
#     if (i != nrow(dt_table_summary)) {
#       gt_table <- gt_table %>%
#         tab_style(
#           style = cell_text(weight = "bold"),
#           locations = cells_body(rows = i, columns = vars(!!var_name))
#         ) %>%
#         tab_style(
#           style = cell_text(indent = px(20)),
#           locations = cells_body(rows = i, columns = vars(!!var_name))
#         )
#     }
#   }
#   return(gt_table)
# }


refactor_variables <- function(dataframe, variable_pattern, levels) {
  selected_variables <- grep(variable_pattern, names(dataframe), value = TRUE)
  for (variable_name in selected_variables) {
    dataframe[[variable_name]] <- factor(dataframe[[variable_name]], levels = levels)
  }
  return(dataframe)
}

# Define variable pattern and levels once you get to the table
# EX:
# variable_pattern <- "^D_114280729_"
# levels <- c(232063618, 948148236,  692824372, "Skipped this Question")
# 
# # Apply the function
# CVD_tib <- refactor_variables(CVD_tib, variable_pattern, levels)

```



```{r CategoryMapping, include=FALSE}

## Add all the variables at once to reduce too many dataframes. Memory issue keeps popping up 



# ## Multi-racial
# 
# multi_race=0    
# for (i in 1:length(data_tib_base$Connect_ID)){
#   AI=ifelse((data_tib_base$D_384191091_D_384191091_D_583826374[[i]]==1 & (data_tib_base$D_384191091_D_384191091_D_636411467[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_458435048[[i]]==1|
#                                                data_tib_base$D_384191091_D_384191091_D_706998638[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_973565052[[i]]==1 |
#                                                data_tib_base$D_384191091_D_384191091_D_586825330[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_412790539[[i]]==1 |
#                                                data_tib_base$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
#   As=ifelse((data_tib_base$D_384191091_D_384191091_D_636411467[[i]]==1 & (data_tib_base$D_384191091_D_384191091_D_583826374[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_458435048[[i]]==1|
#                                                         data_tib_base$D_384191091_D_384191091_D_706998638[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_973565052[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_586825330[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_412790539[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
#   Bl=ifelse((data_tib_base$D_384191091_D_384191091_D_458435048[[i]]==1 & (data_tib_base$D_384191091_D_384191091_D_583826374[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_636411467[[i]]==1|
#                                                         data_tib_base$D_384191091_D_384191091_D_706998638[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_973565052[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_586825330[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_412790539[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
#   Hs=ifelse((data_tib_base$D_384191091_D_384191091_D_706998638[[i]]==1 & (data_tib_base$D_384191091_D_384191091_D_583826374[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_636411467[[i]]==1|
#                                                         data_tib_base$D_384191091_D_384191091_D_458435048[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_973565052[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_586825330[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_412790539[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
#   Me=ifelse((data_tib_base$D_384191091_D_384191091_D_973565052[[i]]==1 & (data_tib_base$D_384191091_D_384191091_D_583826374[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_636411467[[i]]==1|
#                                                         data_tib_base$D_384191091_D_384191091_D_458435048[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_706998638[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_586825330[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_412790539[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
#   Hw=ifelse((data_tib_base$D_384191091_D_384191091_D_586825330[[i]]==1 & (data_tib_base$D_384191091_D_384191091_D_583826374[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_636411467[[i]]==1|
#                                                         data_tib_base$D_384191091_D_384191091_D_458435048[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_706998638[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_973565052[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_412790539[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
#   Wh=ifelse((data_tib_base$D_384191091_D_384191091_D_412790539[[i]]==1 & (data_tib_base$D_384191091_D_384191091_D_583826374[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_636411467[[i]]==1|
#                                                         data_tib_base$D_384191091_D_384191091_D_458435048[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_706998638[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_586825330[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_973565052[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
#   Ot=ifelse((data_tib_base$D_384191091_D_384191091_D_807835037[[i]]==1 & (data_tib_base$D_384191091_D_384191091_D_583826374[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_636411467[[i]]==1|
#                                                         data_tib_base$D_384191091_D_384191091_D_458435048[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_706998638[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_586825330[[i]]==1 | data_tib_base$D_384191091_D_384191091_D_973565052[[i]]==1 |
#                                                         data_tib_base$D_384191091_D_384191091_D_412790539[[i]]==1)), 1, 0)
#   multi_race= multi_race + sum(AI+As+Bl+Hs+Me+Hw+Wh+Ot, na.rm=T)
# 
# }
# 
# #cat("Percentage of multirace participants:", (multi_race/(dim(data_tib_base)[1]))*100)
#    
#    
# 
# data_tib_base$multi_racial <- c(rep(1, times=multi_race), rep(0, times=(dim(data_tib_base)[1]- multi_race)))



race_columns <- c("D_384191091_D_384191091_D_583826374", 
                  "D_384191091_D_384191091_D_636411467",
                  "D_384191091_D_384191091_D_458435048",
                  "D_384191091_D_384191091_D_706998638",
                  "D_384191091_D_384191091_D_973565052",
                  "D_384191091_D_384191091_D_586825330",
                  "D_384191091_D_384191091_D_412790539",
                  "D_384191091_D_384191091_D_807835037")

# All data is currently string values, need to convert "1" and "0" to 1 and 0 to be summarized
data_tib_base[race_columns] <- lapply(data_tib_base[race_columns], as.numeric)
data_tib_base$multi_racial <- ifelse(rowSums(data_tib_base[race_columns], na.rm = TRUE) > 1, 1, 0)


data_tib_base <- data_tib_base %>% 
  mutate(race= case_when(multi_racial==1 ~ "Multi-Racial",
                         D_384191091_D_384191091_D_583826374==1 ~ "American Indian or Native American",
                         D_384191091_D_384191091_D_636411467==1 ~ "Asian/Asian American",
                         D_384191091_D_384191091_D_458435048==1 ~ "Black, African American, or African",
                         D_384191091_D_384191091_D_706998638==1 ~ "Hispanic, Latino, or Spanish",
                         D_384191091_D_384191091_D_973565052==1 ~ "Middle Eastern or North African",
                         D_384191091_D_384191091_D_586825330==1 ~ "Hawaiian or Pacific Islander",
                         D_384191091_D_384191091_D_412790539==1 ~ "White",
                         (D_384191091_D_384191091_D_807835037==1 | !is.na(D_384191091_D_747350323)) ~ "Other",
                         D_384191091_D_384191091_D_746038746==1 ~ "Prefer Not to Answer",
                         TRUE  ~ "Skipped this question"),
         descr= case_when(D_289664241_D_289664241==536341288 | D_289664241_D_289664241==218837028 ~ "Woman",
                          D_289664241_D_289664241==654207589 | D_289664241_D_289664241==983318667 ~ "Man",
                          D_289664241_D_289664241==405267600 ~ "Transgender Man",
                          D_289664241_D_289664241==873138103 ~ "Transgender Woman",
                          D_289664241_D_289664241==805712793 ~ "Genderqueer",
                          D_289664241_D_289664241==486192236 ~ "Non-binary",
                          D_289664241_D_289664241==807835037 ~ "Other",
                          D_289664241_D_289664241==746038746 ~ "Declined",
                          TRUE ~ "Skipped this question"),
         Type= case_when(D_508846529_D_864052438==1 & D_508846529_D_323177352==0~"Basal Cell",
                         D_508846529_D_323177352==1 & D_508846529_D_864052438==0 ~ "Squamous Cell",
                         D_508846529_D_323177352==1 & D_508846529_D_864052438==1 ~ "Both",
                         D_508846529_D_178420302==1 ~ "Unknown",
                         TRUE ~ "Skipped This Question"))


```



\newpage
# Stakeholder Metrics
Objectives of Stakeholder Metrics: Quantify representativeness of self-reported demographics, distribution of co-morbidities and key exposures from baseline surveys, compared to other US cohorts and the US general population.


## RACE
```{r Race, warning=FALSE, echo=FALSE, message=FALSE}

#which_race <- which_race  %>% dplyr::group_by(race) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% dplyr::ungroup()  %>%  dplyr::select(race, n, percentage)

#gt_total_func(which_race, "race", "Race/Ethnicity of Participants Who Completed BOH Section of First Survey")

dt_all_races_summary <- data_tib_base  %>% dplyr::group_by(race) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% dplyr::ungroup()  %>%  dplyr::select(race, n, percentage)

dt_all_races_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Race/Ethnicity of Participants Who Completed BOH Section of First Survey")) %>% 
  cols_label(n= md("**N**"), race = md("**Answer**"), percentage = md("**%**")) %>% 
    grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = race,
    )
  )%>%
  tab_footnote(
    footnote = md("Multi-racial in this table is defined as participants that selected multiple race responses."),
  locations = cells_column_labels(columns = race),
  placement = c("left")
)



```



## Ethnicity
```{r Ethnicity, warning=FALSE, echo=FALSE, message=FALSE}


#American Indian/Native American
dt_am_ind_ethn= data_tib_base %>%  filter(data_tib_base$D_384191091_D_384191091_D_583826374==1)  


dt_am_ind_ethn= dt_am_ind_ethn %>%  mutate(multb2 = ifelse(D_362270886_D_362270886_D_249603425==1, 1, 0) + ifelse(D_362270886_D_362270886_D_530063091==1, 1, 0) + ifelse(D_362270886_D_362270886_D_643489668==1, 1, 0) + 
                                             ifelse(D_362270886_D_362270886_D_807835037==1, 1, 0) + ifelse(D_362270886_D_362270886_D_746038746==1, 1, 0))


dt_am_ind_ethn = dt_am_ind_ethn %>%  mutate(ethnicity= case_when(as.numeric(multb2)>1 ~ "Multi-Ethnic",
                                                          D_362270886_D_362270886_D_249603425==1 ~ "American Indian",
                                             D_362270886_D_362270886_D_530063091==1 ~ "Alaska Native",
                                             D_362270886_D_362270886_D_643489668==1 ~ "Central or South American Indian",
                                             (D_362270886_D_362270886_D_807835037==1 | !is.na(D_362270886_D_650100414)) ~ "Other",
                                             D_362270886_D_362270886_D_746038746==1 ~ "Prefer Not to Answer",
                                             TRUE ~ "Skipped this question"))

dt_am_ind_ethn_summary <- dt_am_ind_ethn %>% group_by(ethnicity) %>%    dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(ethnicity, n, percentage) 

#gt_total_func(dt_am_ind_ethn_summary, "ethnicity", "Ethnicity of American Indian/Native American Participants")
dt_am_ind_ethn_summary %>%  gt::gt(rowname_col = "row_lab") %>%
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("Ethnicity of American Indian/Native American Participants")) %>%
  cols_label(n= md("**N**"), ethnicity = md("**Answer**"), percentage = md("**%**")) %>%
    grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = ethnicity,
    )
  )  %>%
  tab_footnote(
    footnote = md("The denomination of this table is all participants who selected this race/etnicity only, as well as multi-racial participants that selected this race/ethnicity as well as other race/ethnicities."),
  locations = cells_column_labels(columns = n),
  placement = c("left")
) %>%
  tab_footnote(
    footnote = md("Multi-ethnic in this table is defined as participants that selected multiple ethnicity responses."),
  locations = cells_column_labels(columns = ethnicity),
  placement = c("left")
)


#Asian/Asian American
dt_asian= data_tib_base %>% filter(data_tib_base$D_384191091_D_384191091_D_636411467==1)  

dt_asian= dt_asian %>%  mutate(multb2 = ifelse(D_525535977_D_525535977_D_773844957==1, 1, 0) + ifelse(D_525535977_D_525535977_D_901439277==1, 1, 0) + ifelse(D_525535977_D_525535977_D_750168061==1, 1, 0) + 
                                             ifelse(D_525535977_D_525535977_D_326604981==1, 1, 0) + ifelse(D_525535977_D_525535977_D_469918550==1, 1, 0) + ifelse(D_525535977_D_525535977_D_288079668==1, 1, 0) + ifelse(D_525535977_D_525535977_D_240721579==1, 1, 0) + ifelse(D_525535977_D_525535977_D_571633051==1, 1, 0) + ifelse(D_525535977_D_525535977_D_964924704==1, 1, 0) + ifelse(D_525535977_D_525535977_D_807835037==1, 1, 0) + ifelse(D_525535977_D_525535977_D_746038746==1, 1, 0))


                                                          
dt_asian= dt_asian %>%  mutate(ethnicity= case_when(as.numeric(multb2)>1 ~ "Multi-Ethnic",
                                                     D_525535977_D_525535977_D_773844957==1 ~ "Asian indian",
                                             D_525535977_D_525535977_D_901439277==1 ~ "Cambodian",
                                             D_525535977_D_525535977_D_750168061==1 ~ "Chinese",
                                             D_525535977_D_525535977_D_326604981==1 ~ "Filipino",
                                             D_525535977_D_525535977_D_469918550==1 ~ "Hmong",
                                             D_525535977_D_525535977_D_288079668==1 ~ "Japanese",
                                             D_525535977_D_525535977_D_240721579==1 ~ "Korean",
                                             D_525535977_D_525535977_D_571633051==1 ~ "Pakastani",
                                             D_525535977_D_525535977_D_964924704==1 ~ "Vietnamese",
                                             (D_525535977_D_525535977_D_807835037==1 | !is.na(D_525535977_D_396618548)) ~ "Other",
                                             D_525535977_D_525535977_D_746038746==1 ~ "Prefer Not to Answer",
                                             TRUE ~ "Skipped this question"))

dt_asian_summary <- dt_asian %>% group_by(ethnicity) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(ethnicity, n, percentage) 

#gt_total_func(dt_asian_summary, "ethnicity", "Ethnicity of Asian and Asian American Participants")
dt_asian_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Ethnicity of Asian and Asian American Participants")) %>% 
  cols_label(n= md("**N**"), ethnicity = md("**Answer**"), percentage = md("**%**")) %>% 
    grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = ethnicity,
    )
  )  %>%
  tab_footnote(
    footnote = md("The denomination of this table is all participants who selected this race/etnicity only, as well as multi-racial participants that selected this race/ethnicity as well as other race/ethnicities."),
  locations = cells_column_labels(columns = n),
  placement = c("left")
) %>%
  tab_footnote(
    footnote = md("Multi-ethnic in this table is defined as participants that selected multiple ethnicity responses."),
  locations = cells_column_labels(columns = ethnicity),
  placement = c("left")
)




#Black/African/African American 
dt_black= data_tib_base %>% filter(data_tib_base$D_384191091_D_384191091_D_458435048==1)  

dt_black= dt_black %>%  mutate(multb2 = ifelse(D_976808005_D_976808005_D_704774349==1, 1, 0) + ifelse(D_976808005_D_976808005_D_240854115==1, 1, 0) + ifelse(D_976808005_D_976808005_D_280957170==1, 1, 0) + 
                                             ifelse(D_976808005_D_976808005_D_533776046==1, 1, 0) + ifelse(D_976808005_D_976808005_D_647105074==1, 1, 0) + ifelse(D_976808005_D_976808005_D_618222258==1, 1, 0) + ifelse(D_976808005_D_976808005_D_487027241==1, 1, 0) + ifelse(D_976808005_D_976808005_D_900838463==1, 1, 0) + ifelse(D_976808005_D_976808005_D_379093069==1, 1, 0) + ifelse(D_976808005_D_976808005_D_304643362==1, 1, 0) + ifelse(D_976808005_D_976808005_D_151821009==1, 1, 0) + ifelse(D_976808005_D_976808005_D_807835037==1, 1, 0) + ifelse(D_976808005_D_976808005_D_746038746==1, 1, 0))



dt_black= dt_black %>%  mutate(ethnicity= case_when(as.numeric(multb2)>1 ~ "Multi-Ethnic",
                                                     D_976808005_D_976808005_D_704774349==1 ~ "African American",
                                             D_976808005_D_976808005_D_240854115==1 ~ "Barbadian",
                                             D_976808005_D_976808005_D_280957170==1 ~ "Caribbean",
                                             D_976808005_D_976808005_D_533776046==1 ~ "Ethiopian",
                                             D_976808005_D_976808005_D_647105074==1 ~ "Ghanauin",
                                             D_976808005_D_976808005_D_618222258==1 ~ "Haitian",
                                             D_976808005_D_976808005_D_487027241==1 ~ "Jamaican",
                                             D_976808005_D_976808005_D_900838463==1 ~ "Liberian",
                                             D_976808005_D_976808005_D_379093069==1 ~ "Nigerian",
                                             D_976808005_D_976808005_D_304643362==1 ~ "Somali",
                                             D_976808005_D_976808005_D_151821009==1 ~ "South African",
                                             (D_976808005_D_976808005_D_807835037==1 | !is.na(D_976808005_D_852296096)) ~ "Other",
                                             D_976808005_D_976808005_D_746038746==1 ~ "Prefer Not to Answer",
                                             TRUE   ~ "Skipped this question"))



dt_black_summary <- dt_black %>% group_by(ethnicity) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(ethnicity, n, percentage)
#gt_total_func(dt_black_summary, "ethnicity", "Ethnicity of Black/African/African American Participants")
dt_black_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Ethnicity of Black/African/African American Participants")) %>% 
  cols_label(n= md("**N**"), ethnicity = md("**Answer**"), percentage = md("**%**")) %>% 
    grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = ethnicity,
    )
  )  %>%
  tab_footnote(
    footnote = md("The denomination of this table is all participants who selected this race/etnicity only, as well as multi-racial participants that selected this race/ethnicity as well as other race/ethnicities."),
  locations = cells_column_labels(columns = n),
  placement = c("left")
) %>%
  tab_footnote(
    footnote = md("Multi-ethnic in this table is defined as participants that selected multiple ethnicity responses."),
  locations = cells_column_labels(columns = ethnicity),
  placement = c("left")
)



#Hispanic/Latino/Spanish
dt_hisp= data_tib_base  %>% filter(data_tib_base$D_384191091_D_384191091_D_706998638==1) 

dt_hisp= dt_hisp %>%  mutate(multb2 = ifelse(D_308014437_D_308014437_D_810637250==1, 1, 0) + ifelse(D_308014437_D_308014437_D_248444252==1, 1, 0) + ifelse(D_308014437_D_308014437_D_764331628==1, 1, 0) + 
                                             ifelse(D_308014437_D_308014437_D_412757551==1, 1, 0) + ifelse(D_308014437_D_308014437_D_981774939==1, 1, 0) + ifelse(D_308014437_D_308014437_D_432305109==1, 1, 0) + ifelse(D_308014437_D_308014437_D_862718552==1, 1, 0) + ifelse(D_308014437_D_308014437_D_988121468==1, 1, 0) + ifelse(D_308014437_D_308014437_D_773342525==1, 1, 0) + ifelse(D_308014437_D_308014437_D_807835037==1, 1, 0) + ifelse(D_308014437_D_308014437_D_746038746==1, 1, 0))



dt_hisp= dt_hisp %>%  mutate(ethnicity= case_when(as.numeric(multb2)>1 ~ "Multi-Ethnic",
                                                    D_308014437_D_308014437_D_810637250==1 ~ "Columbian",
                                             D_308014437_D_308014437_D_248444252==1 ~ "Cuban",
                                             D_308014437_D_308014437_D_764331628==1 ~ "Dominican",
                                             D_308014437_D_308014437_D_412757551==1 ~ "Ecuadorian",
                                             D_308014437_D_308014437_D_981774939==1 ~ "Hondurian",
                                             D_308014437_D_308014437_D_432305109==1 ~ "Mexican or Mexican American",
                                             D_308014437_D_308014437_D_862718552==1 ~ "Puerto Rican",
                                             D_308014437_D_308014437_D_988121468==1 ~ "Salvadorian",
                                             D_308014437_D_308014437_D_773342525==1 ~ "Spanish",
                                             (D_308014437_D_308014437_D_807835037==1 | !is.na(D_308014437_D_440307926)) ~ "Other",
                                             D_308014437_D_308014437_D_746038746==1 ~ "Prefer Not to Answer",
                                             TRUE   ~ "Skipped this question"))

dt_hisp_summary <- dt_hisp %>% group_by(ethnicity) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(ethnicity, n, percentage)

#gt_total_func(dt_hisp_summary, "ethnicity", "Ethnicity of Hispanic/Latino/Spanish Participants")

dt_hisp_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Ethnicity of Hispanic/Latino/Spanish Participants")) %>% 
  cols_label(n= md("**N**"), ethnicity = md("**Answer**"), percentage = md("**%**")) %>% 
    grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = ethnicity,
    )
  )  %>%
  tab_footnote(
    footnote = md("The denomination of this table is all participants who selected this race/etnicity only, as well as multi-racial participants that selected this race/ethnicity as well as other race/ethnicities."),
  locations = cells_column_labels(columns = n),
  placement = c("left")
) %>%
  tab_footnote(
    footnote = md("Multi-ethnic in this table is defined as participants that selected multiple ethnicity responses."),
  locations = cells_column_labels(columns = ethnicity),
  placement = c("left")
)



#Middle Eastern or North African
dt_mideast= data_tib_base %>%  filter(data_tib_base$D_384191091_D_384191091_D_973565052==1)  

dt_mideast= dt_mideast %>%  mutate(multb2 = ifelse(D_351657815_D_351657815_D_190152384==1, 1, 0) + ifelse(D_351657815_D_351657815_D_119632587==1, 1, 0) + ifelse(D_351657815_D_351657815_D_578616917==1, 1, 0) + 
                                             ifelse(D_351657815_D_351657815_D_834030167==1, 1, 0) + ifelse(D_351657815_D_351657815_D_680575651==1, 1, 0) + ifelse(D_351657815_D_351657815_D_144320785==1, 1, 0) + ifelse(D_351657815_D_351657815_D_214951746==1, 1, 0) + ifelse(D_351657815_D_351657815_D_932563284==1, 1, 0) + ifelse(D_351657815_D_351657815_D_336596477==1, 1, 0) + ifelse(D_351657815_D_351657815_D_380583570==1, 1, 0) + ifelse(D_351657815_D_351657815_D_807835037==1, 1, 0) + ifelse(D_351657815_D_351657815_D_746038746==1, 1, 0))


                                                    
dt_mideast= dt_mideast %>%  mutate(ethnicity= case_when(as.numeric(multb2)>1 ~ "Multi-Ethnic",
                                                       D_351657815_D_351657815_D_190152384==1 ~ "Afghan",
                                             D_351657815_D_351657815_D_119632587==1 ~ "Algerian",
                                             D_351657815_D_351657815_D_578616917==1 ~ "Egyptian",
                                             D_351657815_D_351657815_D_834030167==1 ~ "Iranian",
                                             D_351657815_D_351657815_D_680575651==1 ~ "Iraqi",
                                             D_351657815_D_351657815_D_144320785==1 ~ "Israeli",
                                             D_351657815_D_351657815_D_214951746==1 ~ "Lebanese",
                                             D_351657815_D_351657815_D_932563284==1 ~ "Moroccan",
                                             D_351657815_D_351657815_D_336596477==1 ~ "Syrian",
                                             D_351657815_D_351657815_D_380583570==1 ~ "Tunisian",
                                             (D_351657815_D_351657815_D_807835037==1 | !is.na(D_351657815_D_576646485)) ~ "Other",
                                             D_351657815_D_351657815_D_746038746==1 ~ "Prefer Not to Answer",
                                             TRUE   ~ "Skipped this question"))

dt_mideast_summary <- dt_mideast %>% group_by(ethnicity) %>%   dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(ethnicity, n, percentage)

#gt_total_func(dt_mideast_summary, "ethnicity", "Ethnicity of Middle Eastern or North African Participants")
dt_mideast_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Ethnicity of Middle Eastern or North African Participants")) %>% 
  cols_label(n= md("**N**"), ethnicity = md("**Answer**"), percentage = md("**%**")) %>% 
    grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = ethnicity,
    )
  )  %>%
  tab_footnote(
    footnote = md("The denomination of this table is all participants who selected this race/etnicity only, as well as multi-racial participants that selected this race/ethnicity as well as other race/ethnicities."),
  locations = cells_column_labels(columns = n),
  placement = c("left")
) %>%
  tab_footnote(
    footnote = md("Multi-ethnic in this table is defined as participants that selected multiple ethnicity responses."),
  locations = cells_column_labels(columns = ethnicity),
  placement = c("left")
)





#Hawaiian/ Pacific Islander
dt_hawi= data_tib_base %>%  filter(data_tib_base$D_384191091_D_384191091_D_586825330==1)  

dt_hawi= dt_hawi %>%  mutate(multb2 = ifelse(D_115616118_D_115616118_D_664730658==1, 1, 0) + ifelse(D_115616118_D_115616118_D_949727109==1, 1, 0) + ifelse(D_115616118_D_115616118_D_496132363==1, 1, 0) + 
                                             ifelse(D_115616118_D_115616118_D_453456270==1, 1, 0) + ifelse(D_115616118_D_115616118_D_819018322==1, 1, 0) + ifelse(D_115616118_D_115616118_D_685406566==1, 1, 0) + ifelse(D_115616118_D_115616118_D_786290435==1, 1, 0) + ifelse(D_115616118_D_115616118_D_167028305==1, 1, 0) + ifelse(D_115616118_D_115616118_D_345861266==1, 1, 0) +  ifelse(D_115616118_D_115616118_D_807835037==1, 1, 0) + ifelse(D_115616118_D_115616118_D_746038746==1, 1, 0))

                                                       
dt_hawi= dt_hawi %>%  mutate(ethnicity= case_when(as.numeric(multb2)>1 ~ "Multi-Ethnic",
                                                    D_115616118_D_115616118_D_664730658==1 ~ "Chamorro",
                                             D_115616118_D_115616118_D_949727109==1 ~ "Chuukese",
                                             D_115616118_D_115616118_D_496132363==1 ~ "Fijian",
                                             D_115616118_D_115616118_D_453456270==1 ~ "Marshallese",
                                             D_115616118_D_115616118_D_819018322==1 ~ "Hawaiian",
                                             D_115616118_D_115616118_D_685406566==1 ~ "Palauan",
                                             D_115616118_D_115616118_D_786290435==1 ~ "Samoan",
                                             D_115616118_D_115616118_D_167028305==1 ~ "Tahitian",
                                             D_115616118_D_115616118_D_345861266==1 ~ "Tongan",
                                             (D_115616118_D_115616118_D_807835037==1 | !is.na(D_115616118_D_403180970)) ~ "Other",
                                             D_115616118_D_115616118_D_746038746==1 ~ "Prefer Not to Answer",
                                             TRUE   ~ "Skipped this question"))

dt_hawi_summary <- dt_hawi %>% group_by(ethnicity) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(ethnicity, n, percentage)

#gt_total_func(dt_hawi_summary, "ethnicity", "Ethnicity of Hawaiian or Pacific Islander Participants")
dt_hawi_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Ethnicity of Hawaiian or Pacific Islander Participants")) %>% 
  cols_label(n= md("**N**"), ethnicity = md("**Answer**"), percentage = md("**%**")) %>% 
    grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = ethnicity,
    )
  )  %>%
  tab_footnote(
    footnote = md("The denomination of this table is all participants who selected this race/etnicity only, as well as multi-racial participants that selected this race/ethnicity as well as other race/ethnicities."),
  locations = cells_column_labels(columns = n),
  placement = c("left")
) %>%
  tab_footnote(
    footnote = md("Multi-ethnic in this table is defined as participants that selected multiple ethnicity responses."),
  locations = cells_column_labels(columns = ethnicity),
  placement = c("left")
)



#White
dt_white= data_tib_base %>% filter(data_tib_base$D_384191091_D_384191091_D_412790539==1) 

dt_white= dt_white %>%  mutate(multb2 = ifelse(D_797626610_D_797626610_D_664571574==1, 1, 0) + ifelse(D_797626610_D_797626610_D_163149180==1, 1, 0) + ifelse(D_797626610_D_797626610_D_192776753==1, 1, 0) + 
                                             ifelse(D_797626610_D_797626610_D_733789220==1, 1, 0) + ifelse(D_797626610_D_797626610_D_418464677==1, 1, 0) + ifelse(D_797626610_D_797626610_D_859329001==1, 1, 0) + ifelse(D_797626610_D_797626610_D_267472307==1, 1, 0) + ifelse(D_797626610_D_797626610_D_918190932==1, 1, 0) + ifelse(D_797626610_D_797626610_D_381749264==1, 1, 0) + ifelse(D_797626610_D_797626610_D_704661219==1, 1, 0) + ifelse(D_797626610_D_797626610_D_773342525==1, 1, 0) +  ifelse(D_797626610_D_797626610_D_807835037==1, 1, 0) + ifelse(D_797626610_D_797626610_D_746038746==1, 1, 0))


dt_white= dt_white %>%  mutate(ethnicity= case_when(as.numeric(multb2)>1 ~ "Multi-Ethnic",
                                                     D_797626610_D_797626610_D_664571574==1 ~ "Dutch",
                                             D_797626610_D_797626610_D_163149180==1 ~ "English",
                                             D_797626610_D_797626610_D_192776753==1 ~ "European",
                                             D_797626610_D_797626610_D_733789220==1 ~ "French",
                                             D_797626610_D_797626610_D_418464677==1 ~ "German",
                                             D_797626610_D_797626610_D_859329001==1 ~ "Irish",
                                             D_797626610_D_797626610_D_267472307==1 ~ "Italian",
                                             D_797626610_D_797626610_D_918190932==1 ~ "Norwegian",
                                             D_797626610_D_797626610_D_381749264==1 ~ "Polish",
                                             D_797626610_D_797626610_D_704661219==1 ~ "Scottish",
                                             D_797626610_D_797626610_D_773342525==1 ~ "Spanish",
                                             (D_797626610_D_797626610_D_807835037==1 | !is.na(D_797626610_D_774928994)) ~ "Other",
                                             D_797626610_D_797626610_D_746038746==1 ~ "Prefer Not to Answer",
                                             TRUE   ~ "Skipped this question"))

dt_white_summary <- dt_white %>% group_by(ethnicity) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(ethnicity, n, percentage)

#gt_total_func(dt_white_summary, "ethnicity", "Ethnicity of White Participants")
dt_white_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Ethnicity of White Participants")) %>% 
  cols_label(n= md("**N**"), ethnicity = md("**Answer**"), percentage = md("**%**")) %>% 
    grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = ethnicity,
    )
  )  %>%
  tab_footnote(
    footnote = md("The denomination of this table is all participants who selected this race/etnicity only, as well as multi-racial participants that selected this race/ethnicity as well as other race/ethnicities."),
  locations = cells_column_labels(columns = n),
  placement = c("left")
) %>%
  tab_footnote(
    footnote = md("Multi-ethnic in this table is defined as participants that selected multiple ethnicity responses."),
  locations = cells_column_labels(columns = ethnicity),
  placement = c("left")
)

```


## SEX/ SEX2/ GENDER/ SEXORIENT
```{r SGM, warning=FALSE,echo=FALSE}

#levels_list <- c("Female", "Male", "Unknown", "Skipped this Question")
data_tib_base$D_407056417 <- factor(data_tib_base$D_407056417,levels=c( 536341288,654207589, 576796184, "Skipped this Question"))

simple_funct1(D_407056417, "Sex at birth")




#Style
# data_tib_base$descr <- factor(data_tib_base$descr,levels=c("Woman", "Man", "Transgender Man", "Transgender Woman", "Genderqueer", "Non-binary", "Other", "Declined", "Skipped this question"))
# 
# dt_appearence_summary <- data_tib_base  %>% dplyr::group_by(descr) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))   %>% dplyr::ungroup() %>%  dplyr::select(descr, n, percentage)
# 
# # result <- gt_total_func(dt_appearence_summ, "descr", "Gender")
# # 
# # tab_footnote(
# #   result,
# #   md("These response options are mutually exclusive categories; only one response may be selected."),
# #   locations = cells_column_labels(columns = descr),
# #   placement = c("left")
# # )
# dt_appearence_summary %>%  gt::gt(rowname_col = "row_lab") %>%
#   fmt_number(columns = "percentage", decimals = 2) %>% 
#   fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
#   tab_header(title = md("Gender")) %>%
#   cols_label(n= md("**N**"),descr = md("**Description**"), percentage = md("**%**")) %>%
#   grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = descr,
#     )
#    ) 





# SEX2

dt_sex2= data_tib_base %>%  mutate(multb2 = ifelse(D_750420077_D_846483618==1, 1, 0) + ifelse(D_750420077_D_505282171==1, 1, 0) + ifelse(D_750420077_D_578416151==1, 1, 0) + 
                               ifelse(D_750420077_D_434651539==1, 1, 0) + ifelse(D_750420077_D_108025529==1, 1, 0) + ifelse(D_750420077_D_582784267==1, 1, 0) + ifelse(D_750420077_D_751402477==1, 1, 0) +
                               ifelse(D_750420077_D_700100953==1, 1, 0) )


dt_sex2= dt_sex2 %>%  mutate(body_part= case_when(as.numeric(multb2)>1 ~ "Multiple Body Parts",
                                                     D_750420077_D_582784267==1 ~ "Penis",
                                             D_750420077_D_751402477==1 ~ "Testes",
                                             D_750420077_D_700100953==1 ~ "Prostate Gland",
                                             D_750420077_D_846483618==1 ~ "Vagina",
                                             D_750420077_D_505282171==1 ~ "Cervix",
                                             D_750420077_D_578416151==1 ~ "Uterus",
                                             D_750420077_D_434651539==1 ~ "Ovaries",
                                             D_750420077_D_108025529==1 ~ "Fallopian Tubes",
                                             TRUE   ~ "Skipped this question"))

dt_sex2_summary <- dt_sex2 %>% group_by(body_part) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(body_part, n, percentage)

#gt_total_func(dt_sex2_summary, "body_part", "Body Parts Participants Were Born With")
dt_sex2_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Body Parts Participants Were Born With")) %>% 
  cols_label(n= md("**N**"), body_part = md("**Answer**"), percentage = md("**%**")) %>% 
    grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = body_part,
    )
  ) 



# 
# #Appearance/Style
# data_tib_base$D_987107433 <- factor(data_tib_base$D_987107433, levels=c(220083334,541300533,878286618,910745276,510148951,265452386,915528806,746038746, "Skipped this Question"))
# simple_funct1(D_987107433, "STYLE: Appearence, Style, Dress, Mannerisms")
# 
# 
# data_tib_base$D_555481393_D_555481393 <- factor(data_tib_base$D_555481393_D_555481393, levels=c(271882746,903084185,999994434,727200870,854349138,832978839,197935377,410008111,831942158,210894509,807835037,178420302,746038746, "Skipped this Question"))
# simple_funct1(D_555481393_D_555481393, "SEXORIENT: Sexual Orienation")
# #data_tib_base %>%  select(D_555481393_D_979809707) %>% filter(!is.na(D_555481393_D_979809707)) %>% gt::gt() %>% cols_label(D_555481393_D_979809707= md("**Response for 'Other' Sexual Orientation**"))
# 


```



## LANG
```{r Language, warning=FALSE,echo=FALSE}

data_tib_base <- data_tib_base %>%
  mutate(multc1 = 0)  # Initialize the multc1 column with zeros

# Filter columns based on pattern
columns_to_sum <- colnames(data_tib_base)[grepl("D_207025341_D_207025341_D_", colnames(data_tib_base))]

# Loop through each column and apply the operation
for (col in columns_to_sum) {
  data_tib_base <- data_tib_base %>%
    mutate(multc1 = ifelse(.data[[col]] == 1, 1, 0) + .data$multc1)
}

which_lang= data_tib_base %>%  mutate(language= case_when(as.numeric(multc1)>1 ~ "Multi-Lingual",
                                                        D_588212264_D_588212264_D_163149180==1 ~ "English",
                                                          D_588212264_D_588212264_D_773342525==1 ~ "Spanish",
                                                          D_588212264_D_588212264_D_918819379==1 ~ "Spanish Creole",
                                                          D_588212264_D_588212264_D_733789220==1 ~ "French",
                                                          D_588212264_D_588212264_D_760008937==1 ~ "French Creole",
                                                          D_588212264_D_588212264_D_267472307==1 ~ "Italian",
                                                          D_588212264_D_588212264_D_563857306==1 ~ "Portuguese",
                                                          D_588212264_D_588212264_D_418464677==1 ~ "German",
                                                          D_588212264_D_588212264_D_236546933==1 ~ "Russian",
                                                          D_588212264_D_588212264_D_381749264==1 ~ "Polish",
                                                          D_588212264_D_588212264_D_553424289==1 ~ "Hindi",
                                                          D_588212264_D_588212264_D_750168061==1 ~ "Chinese",
                                                          D_588212264_D_588212264_D_240721579==1 ~ "Korean",
                                                          D_588212264_D_588212264_D_964924704==1 ~ "Vietnamese",
                                                          D_588212264_D_588212264_D_964924704==1 ~ "Tagalog",
                                                          D_588212264_D_588212264_D_367462243==1 ~ "Ilocano",
                                                          D_588212264_D_588212264_D_288079668==1 ~ "Japanese",
                                                          D_588212264_D_588212264_D_669977999==1 ~ "Arabic",
                                                          (D_588212264_D_588212264_D_807835037==1 | !is.na(D_588212264_D_486535201)) ~ "Other",
                                                          TRUE   ~ "Skipped this Question"))

dt_language_summary <- which_lang %>% group_by(language) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(language, n, percentage)

dt_language_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("LANG: Language Spoken in Childhood Home")) %>% 
  cols_label(n= md("**N**"), language = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
    stub.font.weight = "bold"
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = language,
    )
  ) 




```


## SKINCANC, SKINCANC2 
```{r skincancer, warning=FALSE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")


##Cancer
#Ever diagnosed
simple_funct1(D_537153788, "SKINCANC: Diagnosed with Non-Melanoma Skin Cancer")



skincnc_type= data_tib_base %>%  filter(D_537153788==353358909) %>%  
  mutate(Type = factor(Type,levels=c("Basal Cell", "Squamous Cell", "Both", "Unknown", "Skipped This Question")))

dt_skincnc_type_summary <- skincnc_type %>% dplyr::group_by(Type) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Type, n, percentage)

#gt_total_func(dt_skincnc_type_summary, "Type", "SKINCANC2: Type(s) or Skin Cancer Diagnosed")
dt_skincnc_type_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("SKINCANC2: Type(s) or Skin Cancer Diagnosed")) %>% 
  cols_label(n= md("**N**"),Type = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = Type,
    )
  ) 


boxp_funct(D_904550680_D_206625031, "Age Diagnosed with Skin Cancer", "Age")

```


## MH GROUP1
```{r MhGroup1, warning=FALSE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")
                      
                      
mhgroup1COUNT <- data_tib_base %>%
  mutate(
    `B12 Deficiency` = if_else(D_167101091_D_698944820 == 1, 1, 0),
    `Coronary Artery` = if_else(D_167101091_D_838744325 == 1, 1, 0),
    `Congestive Heart Failure` = if_else(D_167101091_D_769790179 == 1, 1, 0),
    `High Cholesterol` = if_else(D_167101091_D_699553344 == 1, 1, 0),
    `Heart Attack` = if_else(D_167101091_D_700811160 == 1, 1, 0),
    `Abnormal Heart Rhythm` = if_else(D_167101091_D_336505365 == 1, 1, 0),
    `Chest Pain` = if_else(D_167101091_D_132548932 == 1, 1, 0),
    `Heart Valve Problems` = if_else(D_167101091_D_747787163 == 1, 1, 0),
    `High Blood Pressure` = if_else(D_167101091_D_693851465 == 1, 1, 0),
    `Blood Clots` = if_else(D_167101091_D_512012656 == 1, 1, 0),
    Stroke = if_else(D_167101091_D_619337095 == 1, 1, 0),
    None = if_else(D_167101091_D_535003378 == 1, 1, 0),
    Skipped = if_else(rowSums(select(., starts_with("D_167101091_D_")) == 0 | is.na(select(., starts_with("D_167101091_D_")))) == ncol(select(., starts_with("D_167101091_D_"))), 1, 0)
  )

pivot_data <- mhgroup1COUNT %>%
  select(`B12 Deficiency`:Skipped) %>%
  pivot_longer(cols = everything(), names_to = "Condition", values_to = "Selected") %>%
  filter(Selected == 1) %>%
  group_by(Condition) %>%
  summarise(Frequency = n()) %>%
  ungroup() %>%
  mutate(Percentage = 100 * Frequency / sum(Frequency))

dt_mgr1 <- pivot_data %>%
  gt() %>%
  fmt_number(columns = "Percentage", decimals = 2) %>% 
  fmt_number(column = "Frequency", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("MHGROUP1: Diagnosed Cardiovascular Conditions")) %>%
  cols_label(Frequency = md("**N**"), 
             Percentage = md("**%**"),  
             Condition = md("**Answer**")) %>%
  tab_options(stub.font.weight = "bold") %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Condition)
  ) %>%
  tab_footnote(
    md("As this is a select all question, participants may select multiple responses."),
    locations = cells_column_labels(columns = Percentage),
    placement = c("left")
  )


dt_mgr1


```



## MH GROUP2
```{r MhGroup2, warning=FALSE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")

mhgroup2 <- data_tib_base %>%
  mutate(
    `Chronic Lung Disease` = if_else(D_894259747_D_359025642 == 1, 1, 0),
    Asthma = if_else(D_894259747_D_407340134 == 1, 1, 0),
    `Hay Fever` = if_else(D_894259747_D_427219143 == 1, 1, 0),
    None = if_else(D_894259747_D_535003378 == 1, 1, 0),
    Skipped = if_else(rowSums(select(., starts_with("D_894259747_D_")) == 0 | is.na(select(., starts_with("D_894259747_D_")))) == ncol(select(., starts_with("D_894259747_D_"))), 1, 0)
  )

pivot_data2 <- mhgroup2 %>%
  select(`Chronic Lung Disease`:Skipped) %>%
  pivot_longer(cols = everything(), names_to = "Condition", values_to = "Selected") %>%
  filter(Selected == 1) %>%
  group_by(Condition) %>%
  summarise(Frequency = n()) %>%
  ungroup() %>%
  mutate(Percentage = 100 * Frequency / sum(Frequency))

dt_mgr2 <- pivot_data2 %>%
  gt() %>%
  fmt_number(columns = "Percentage", decimals = 2) %>% 
  fmt_number(column = "Frequency", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("MHGROUP2: Diagnosed Respiratory Conditions")) %>%
  cols_label(Frequency = md("**N**"), 
             Percentage = md("**%**"),  
             Condition = md("**Answer**")) %>%
  tab_options(stub.font.weight = "bold") %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Condition)
  ) %>%
  tab_footnote(
    footnote = "As this is a select all question, participants may select multiple responses.",
    locations = cells_column_labels(Percentage)
  ) %>%
  tab_footnote(
    footnote = md("Hay Fever includes Allergy to pollen or Allergic Rhinitis."),
    locations = cells_column_labels(Condition)
  )

dt_mgr2



```


## MH GROUP3
```{r MhGroup3, warning=FALSE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")


mhgroup3 <- data_tib_base %>%
  mutate(
    `Esophageal Acid Reflex` = if_else(D_180961306_D_406890409 == 1, 1, 0),
    `Barrett's Esophagus` = if_else(D_180961306_D_704544306 == 1, 1, 0),
    `Irritable Bowel Syndrome` = if_else(D_180961306_D_691766591 == 1, 1, 0),
    `Inflammatory Bowel Disease` = if_else(D_180961306_D_308645635 == 1, 1, 0),
    `Diverticulitis or Diverticulosis` = if_else(D_180961306_D_731115613 == 1, 1, 0),
    `Ulcerative Colitis` = if_else(D_180961306_D_567284980 == 1, 1, 0),
    `Crohn's Disease` = if_else(D_180961306_D_986548173 == 1, 1, 0),
    `Celiac Disease` = if_else(D_180961306_D_285995100 == 1, 1, 0),
    Gallstones = if_else(D_180961306_D_545628561 == 1, 1, 0),
    `Liver Cirrhosis` = if_else(D_180961306_D_709786039 == 1, 1, 0),
    Pancreatitis = if_else(D_180961306_D_984479578 == 1, 1, 0),
    None = if_else(D_180961306_D_535003378 == 1, 1, 0),
    Skipped = if_else(rowSums(select(., starts_with("D_180961306_D_")) == 0 | is.na(select(., starts_with("D_180961306_D_")))) == ncol(select(., starts_with("D_180961306_D_"))), 1, 0)
  )

pivot_data3 <- mhgroup3 %>%
  select(`Esophageal Acid Reflex`:Skipped) %>%
  pivot_longer(cols = everything(), names_to = "Condition", values_to = "Selected") %>%
  filter(Selected == 1) %>%
  group_by(Condition) %>%
  summarise(Frequency = n()) %>%
  ungroup() %>%
  mutate(Percentage = 100 * Frequency / sum(Frequency))

dt_mgr3 <- pivot_data3 %>%
  gt() %>%
  fmt_number(columns = "Percentage", decimals = 2) %>% 
  fmt_number(column = "Frequency", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("MHGROUP3: Diagnosed Digestive System Problems")) %>%
  cols_label(Frequency = md("**N**"), 
             Percentage = md("**%**"),  
             Condition = md("**Answer**")) %>%
  tab_options(stub.font.weight = "bold") %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Condition)
  )
tab_footnote(
  dt_mgr3,
  md("As this is a select all question, participants may select multiple responses."),
  locations = cells_column_labels(columns = Percentage),
  placement = c("left")
)

```


## MH GROUP4
```{r MhGroup4, warning=FALSE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")


mhgroup4 <- data_tib_base %>%
  mutate(
    `Thyroid Disorder` = if_else(D_900541533_D_726539692 == 1, 1, 0),
    `Diabetes` = if_else(D_900541533_D_158044532 == 1, 1, 0),
    `Graves' Disease` = if_else(D_900541533_D_943054522 == 1, 1, 0),
    None = if_else(D_900541533_D_535003378 == 1, 1, 0),
    Skipped = if_else(rowSums(select(., starts_with("D_900541533_D_")) == 0 | is.na(select(., starts_with("D_900541533_D_")))) == ncol(select(., starts_with("D_900541533_D_"))), 1, 0)
  )

pivot_data4 <- mhgroup4 %>%
  select(`Thyroid Disorder`:`Skipped`) %>%
  pivot_longer(cols = everything(), names_to = "Condition", values_to = "Selected") %>%
  filter(Selected == 1) %>%
  group_by(Condition) %>%
  summarise(Frequency = n()) %>%
  ungroup() %>%
  mutate(Percentage = 100 * Frequency / sum(Frequency))

dt_mgr4 <- pivot_data4 %>%
  gt() %>%
  fmt_number(columns = "Percentage", decimals = 2) %>% 
  fmt_number(column = "Frequency", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("MHGROUP4: Diagnosed with Any of These Conditions")) %>%
  cols_label(Frequency = md("**N**"), 
             Percentage = md("**%**"),  
             Condition = md("**Answer**")) %>%
  tab_options(stub.font.weight = "bold") %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Condition)
  ) %>%
  tab_footnote(
    md("As this is a select all question, participants may select multiple responses."),
    locations = cells_column_labels(Percentage)
  )

dt_mgr4




```


## DM
```{r DM, warning=FALSE, echo=FALSE, message=FALSE}

data_tib_base$D_494032093 <- factor(data_tib_base$D_494032093, levels=c(146477090, 573635975, 178420302, "Skipped this Question"))
one_logic_funct(D_494032093, D_900541533_D_158044532, 1, "Type of Diabetes")
```

## MH GROUP5
```{r MhGroup5, warning=FALSE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")


mhgroup5 <- data_tib_base %>%
  mutate(
    `Kidney Stones` = if_else(D_874046190_D_827542780 == 1, 1, 0),
    `Chronic Kidney Disease` = if_else(D_874046190_D_167238688 == 1, 1, 0),
    None = if_else(D_874046190_D_535003378 == 1, 1, 0),
    Skipped = if_else(rowSums(select(., starts_with("D_874046190_D_")) == 0 | is.na(select(., starts_with("D_874046190_D_")))) == ncol(select(., starts_with("D_874046190_D_"))), 1, 0)
  )

pivot_data5 <- mhgroup5 %>%
  select(`Kidney Stones`:`Skipped`) %>%
  pivot_longer(cols = everything(), names_to = "Condition", values_to = "Selected") %>%
  filter(Selected == 1) %>%
  group_by(Condition) %>%
  summarise(Frequency = n()) %>%
  ungroup() %>%
  mutate(Percentage = 100 * Frequency / sum(Frequency))

dt_mgr5 <- pivot_data5 %>%
  gt() %>%
  fmt_number(columns = "Percentage", decimals = 2) %>% 
  fmt_number(column = "Frequency", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("MHGROUP5: Diagnosed with Kidney Conditions")) %>%
  cols_label(Frequency = md("**N**"), 
             Percentage = md("**%**"),  
             Condition = md("**Answer**")) %>%
  tab_options(stub.font.weight = "bold") %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Condition)
  ) %>%
  tab_footnote(
    md("As this is a select all question, participants may select multiple responses."),
    locations = cells_column_labels(Percentage)
  )

dt_mgr5


```


## MH GROUP6
```{r MhGroup6, warning=FALSE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")



mhgroup6 <- data_tib_base %>%
  mutate(
    `Rheumatoid Arthritis` = if_else(D_543728565_D_636030086 == 1, 1, 0),
    Lupus = if_else(D_543728565_D_239687183 == 1, 1, 0),
    Gout = if_else(D_543728565_D_134592375 == 1, 1, 0),
    None = if_else(D_543728565_D_535003378 == 1, 1, 0),
    Skipped = if_else(rowSums(select(., starts_with("D_543728565_D_")) == 0 | is.na(select(., starts_with("D_543728565_D_")))) == ncol(select(., starts_with("D_543728565_D_"))), 1, 0)
  )

pivot_data6 <- mhgroup6 %>%
  select(`Rheumatoid Arthritis`:Skipped) %>%
  pivot_longer(cols = everything(), names_to = "Condition", values_to = "Selected") %>%
  filter(Selected == 1) %>%
  group_by(Condition) %>%
  summarise(Frequency = n()) %>%
  ungroup() %>%
  mutate(Percentage = 100 * Frequency / sum(Frequency))

dt_mgr6 <- pivot_data6 %>%
  gt() %>%
  fmt_number(columns = "Percentage", decimals = 2) %>% 
  fmt_number(column = "Frequency", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("MHGROUP6: Diagnosed with Systemic Conditions")) %>%
  cols_label(Frequency = md("**N**"), 
             Percentage = md("**%**"), 
             Condition = md("**Answer**")) %>%
  tab_options(stub.font.weight = "bold") %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Condition)
  ) %>%
  tab_footnote(
    md("As this is a select all question, participants may select multiple responses."),
    locations = cells_column_labels(Percentage)
  )

dt_mgr6


```


## MH GROUP7
```{r MhGroup7, warning=FALSE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")

mhgroup7 <- data_tib_base %>%
  mutate(
    Mono = if_else(D_874709643_D_164910211 == 1, 1, 0),
    Shingles = if_else(D_874709643_D_796616844 == 1, 1, 0),
    `Chronic Hepatitis B or C` = if_else(D_874709643_D_436689514 == 1, 1, 0),
    Gonorrhea = if_else(D_874709643_D_296357383 == 1, 1, 0),
    Chlamydia = if_else(D_874709643_D_901077233 == 1, 1, 0),
    Trich = if_else(D_874709643_D_136956596 == 1, 1, 0),
    Syphilis = if_else(D_874709643_D_455776698 == 1, 1, 0),
    `Genital Warts` = if_else(D_874709643_D_155874194 == 1, 1, 0),
    HPV = if_else(D_874709643_D_880962432 == 1, 1, 0),
    `HIV/AIDS` = if_else(D_874709643_D_691450854 == 1, 1, 0),
    None = if_else(D_874709643_D_535003378 == 1, 1, 0),
    Skipped = if_else(rowSums(select(., starts_with("D_874709643_D_")) == 0 | is.na(select(., starts_with("D_874709643_D_")))) == ncol(select(., starts_with("D_874709643_D_"))), 1, 0)
  )

pivot_data7 <- mhgroup7 %>%
  select(Mono:Skipped) %>%
  pivot_longer(cols = everything(), names_to = "Condition", values_to = "Selected") %>%
  filter(Selected == 1) %>%
  group_by(Condition) %>%
  summarise(Frequency = n()) %>%
  ungroup() %>%
  mutate(Percentage = 100 * Frequency / sum(Frequency))

dt_mgr7 <- pivot_data7 %>%
  gt() %>%
  fmt_number(columns = "Percentage", decimals = 2) %>% 
  fmt_number(column = "Frequency", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("MHGROUP7: Diagnosed Infections or Diseases")) %>%
  cols_label(Frequency = md("**N**"), 
             Percentage = md("**%**"), 
             Condition = md("**Answer**")) %>%
  tab_options(stub.font.weight = "bold") %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Condition)
  ) %>%
  tab_footnote(
    md("As this is a select all question, participants may select multiple responses."),
    locations = cells_column_labels(Percentage)
  )

dt_mgr7


```


## MH GROUP8
```{r MhGroup8, warning=FALSE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")

mhgroup8 <- data_tib_base %>%
  mutate(
    `Uterine Fibroids` = if_else(D_725626004_D_509721537 == 1, 1, 0),
    Endometriosis = if_else(D_725626004_D_863286658 == 1, 1, 0),
    `Polycystic Ovary Syndrome` = if_else(D_725626004_D_386524148 == 1, 1, 0),
    `Enlarged Prostate` = if_else(D_725626004_D_937208760 == 1, 1, 0),
    `Fibrocystic Breast or Benign Breast Disease` = if_else(D_725626004_D_746542057 == 1, 1, 0),
    `Ductal Carcinoma in situ` = if_else(D_725626004_D_854945381 == 1, 1, 0),
    None = if_else(D_725626004_D_535003378 == 1, 1, 0),
    Skipped = if_else(rowSums(select(., starts_with("D_725626004_D_")) == 0 | is.na(select(., starts_with("D_725626004_D_")))) == ncol(select(., starts_with("D_725626004_D_"))), 1, 0)
  )

pivot_data8 <- mhgroup8 %>%
  select(`Uterine Fibroids`:Skipped) %>%
  pivot_longer(cols = everything(), names_to = "Condition", values_to = "Selected") %>%
  filter(Selected == 1) %>%
  group_by(Condition) %>%
  summarise(Frequency = n()) %>%
  ungroup() %>%
  mutate(Percentage = 100 * Frequency / sum(Frequency))

dt_mgr8 <- pivot_data8 %>%
  gt() %>%
  fmt_number(columns = "Percentage", decimals = 2) %>% 
  fmt_number(column = "Frequency", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("MHGROUP8: Diagnosed Urinary and Reproductive Problems")) %>%
  cols_label(Frequency = md("**N**"), 
             Percentage = md("**%**"), 
             Condition = md("**Answer**")) %>%
  tab_options(stub.font.weight = "bold") %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Condition)
  ) %>%
  tab_footnote(
    md("As this is a select all question, participants may select multiple responses."),
    locations = cells_column_labels(Percentage)
  )

dt_mgr8



```


## BREASTDISC4
```{r breastdis4, warning=FALSE, echo=FALSE, message=FALSE}

one_logic_funct(D_852236900, D_725626004_D_854945381, 1, "BREASTDIS4: DCIS Confirmed with Biopsy")


```
## DEPRESS
```{r depress, warning=FALSE, echo=FALSE, message=FALSE}

simple_funct1(D_347860896, "DEPRESS: Diagnosed with Clinical Depression")



```


## MH GROUP9
```{r MhGroup9, warning=FALSE, echo=FALSE, message=FALSE}


knitr::opts_chunk$set(dev = "png", fig.path = "")


mhgroup9 <- data_tib_base %>%
  mutate(
    `Tonsillectomy` = if_else(D_624179836_D_797189152 == 1, 1, 0),
    Cholecystectomy = if_else(D_624179836_D_633546100 == 1, 1, 0),
    Appendectomy = if_else(D_624179836_D_866002271 == 1, 1, 0),
    Liposuction = if_else(D_624179836_D_118789503 == 1, 1, 0),
    `Gastric Bypass` = if_else(D_624179836_D_715563991 == 1, 1, 0),
    `Breast Surgery` = if_else(D_624179836_D_533491176 == 1, 1, 0),
    Hysterectomy = if_else(D_624179836_D_220755749 == 1, 1, 0),
    `Tubal Ligation` = if_else(D_624179836_D_465318416 == 1, 1, 0),
    Oophorectomy = if_else(D_624179836_D_630100221 == 1, 1, 0),
    Salpingectomy = if_else(D_624179836_D_692881833 == 1, 1, 0),
    Vasectomy = if_else(D_624179836_D_654450030 == 1, 1, 0),
    `Orchiectomy or Orchidectomy` = if_else(D_624179836_D_532603425 == 1, 1, 0),
    Prostatectomy = if_else(D_624179836_D_733236542 == 1, 1, 0),
    Penectomy = if_else(D_624179836_D_961987554 == 1, 1, 0),
    None = if_else(D_624179836_D_535003378 == 1, 1, 0),
    Skipped = if_else(rowSums(select(., starts_with("D_624179836_D_")) == 0 | is.na(select(., starts_with("D_624179836_D_")))) == ncol(select(., starts_with("D_624179836_D_"))), 1, 0)
  )

pivot_data9 <- mhgroup9 %>%
  select(`Tonsillectomy`:Skipped) %>%
  pivot_longer(cols = everything(), names_to = "Surgery", values_to = "Selected") %>%
  filter(Selected == 1) %>%
  group_by(Surgery) %>%
  summarise(Frequency = n()) %>%
  ungroup() %>%
  mutate(Percentage = 100 * Frequency / sum(Frequency))

dt_mgr9 <- pivot_data9 %>%
  gt() %>%
  fmt_number(columns = "Percentage", decimals = 2) %>% 
  fmt_number(column = "Frequency", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("MHGROUP9: Surgeries Had")) %>%
  cols_label(Frequency = md("**N**"), 
             Percentage = md("**%**"), 
             Surgery = md("**Answer**")) %>%
  tab_options(stub.font.weight = "bold") %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = Surgery)
  ) %>%
  tab_footnote(
    footnote = "As this is a select all question, participants may select multiple responses.",
    locations = cells_column_labels(columns = Percentage)
  ) %>%
  tab_footnote(
    footnote = md("Breast Surgeries include: Breast implants, Mastopexy, Breast reconstruction, Breast reduction, Breast-Conserving Surgery (BCS), Lumpectomy, Partial Mastectomy, Segmental Mastectomy, Mastectomy, Double Mastectomy, Bilateral Mastectomy, Surgery for a breast abscess, Microdochectomy."),
    locations = cells_column_labels(columns = Surgery)
  )

dt_mgr9


```

## OVERHEALTH
```{r overall, warning=FALSE, echo=FALSE, message=FALSE}

##Overall
data_tib_base$D_875208305 <- factor(data_tib_base$D_875208305, levels=c(670680466,565881164,719933364,131550264,138752522, "Skipped this Question"))
simple_funct1(D_875208305, "OVERHEALTH: General Health Rating")


```


## BMI
```{r bmi, echo=FALSE, warning=FALSE, message=FALSE}

knitr::opts_chunk$set(dev = "png", fig.path = "")



#Remove unnecessary dataframes to reduce memory
rm(list = setdiff(ls(), c("merged", "data_tib_base", "parts_data", "simple_funct1", "dict", "project")))


data_tib_base$D_114314839_D_340854069=as.numeric(data_tib_base$D_114314839_D_340854069)
data_tib_base$D_114314839_D_600462977=as.numeric(data_tib_base$D_114314839_D_600462977)

data_tib_base$in_D_inches= (ifelse(is.na(data_tib_base$D_114314839_D_340854069), 0,(data_tib_base$D_114314839_D_340854069*12)))+ 
  (ifelse(is.na(data_tib_base$D_114314839_D_600462977), 0, (data_tib_base$D_114314839_D_600462977))) 

data_tib_base$D_746012894=as.numeric(data_tib_base$D_746012894) 
data_tib_base$D_746012894=round(data_tib_base$D_746012894, digits=0)

data_tib_base= data_tib_base %>%  mutate(BMI= (D_746012894/in_D_inches^2)*703)

bmi_box= data_tib_base %>%  filter(!is.na(BMI)) %>%  ggplot(aes(x=BMI))+
    xlab("Score") + geom_boxplot()+  ggtitle("BMI Distribution of Participants") + xlim(c(0,100))

bmi_box

```


## Primary Relative Diagnosed with Cancer
### This Inludes Parents, Siblings, and Children
```{r PrimRelCancer, echo=FALSE, warning=FALSE, message=FALSE}

# degree1_cancer= module3 %>%  filter(ifelse(D_276353712==353358909 | D_659784914==353358909 | D_607773106_1_1==353358909 | D_607773106_2_2==353358909 | 
#                                       D_607773106_3_3==353358909 | D_607773106_4_4==353358909 | D_607773106_5_5==353358909 | D_607773106_6_6==353358909 |
#                                       D_607773106_7_7==353358909| D_607773106_8_8==353358909 | D_607773106_9_9==353358909| D_607773106_10_10==353358909 |
#                                       D_607773106_11_11==353358909 | D_607773106_12_12==353358909 | D_607773106_13_13==353358909 | D_718867914_1_1==353358909 | 
#                                       D_718867914_2_2==353358909 | D_718867914_3_3==353358909 | D_718867914_4_4==353358909 | D_718867914_5_5==353358909 |
#                                       D_718867914_6_6==353358909 | D_718867914_7_7==353358909 | D_718867914_8_8==353358909 | D_718867914_9_9==353358909 |
#                                       D_718867914_10_10==353358909), 1, 0)



family= data_tib_base  %>%  mutate(status= case_when((D_276353712==353358909 | D_659784914==353358909 | D_607773106_1_1==353358909 | D_607773106_2_2==353358909 | 
                                      D_607773106_3_3==353358909 | D_607773106_4_4==353358909 | D_607773106_5_5==353358909 | D_607773106_6_6==353358909 |
                                      D_607773106_7_7==353358909| D_607773106_8_8==353358909 | D_607773106_9_9==353358909| D_607773106_10_10==353358909 |
                                      D_607773106_11_11==353358909 | D_607773106_12_12==353358909 | D_607773106_13_13==353358909 | D_718867914_1_1==353358909 | 
                                      D_718867914_2_2==353358909 | D_718867914_3_3==353358909 | D_718867914_4_4==353358909 | D_718867914_5_5==353358909 |
                                      D_718867914_6_6==353358909 | D_718867914_7_7==353358909 | D_718867914_8_8==353358909 | D_718867914_9_9==353358909 |
                                      D_718867914_10_10==353358909) ~ "Yes", 
                                                    TRUE ~ "No"))


dt_fam_canc_summary <- family %>% group_by(status) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(status, n, percentage)

#gt_total_func(dt_fam_canc_summary, "status", "Primary Relative(s) Diagnosed With Cancer")

dt_fam_canc_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Primary Relative(s) Diagnosed With Cancer")) %>% 
  cols_label(n= md("**N**"), status = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
    stub.font.weight = "bold"
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = status,
    )
  ) 

```



## MOMCANC & MOMCANC2
```{r MomCancer, warning=FALSE, echo=FALSE, message=FALSE}
#cancer? 
simple_funct1(D_276353712, "MOMCANC: Mother Diagnosed with Cancer")


#MOMCANC2
#type:
dt_mom_cnc= data_tib_base %>% filter(D_276353712==353358909) 

dt_mom_cnc <- dt_mom_cnc %>%
  mutate(multc1 = 0)

# Filter columns based on pattern
columns_to_sum <- colnames(dt_mom_cnc)[grepl("D_814510313_D_814510313_", colnames(dt_mom_cnc))]

# Loop through each column and apply the operation
for (col in columns_to_sum) {
  dt_mom_cnc <- dt_mom_cnc %>%
    mutate(multc1 = ifelse(.data[[col]] == 1, 1, 0) + .data$multc1)
}

# momcnc= dt_mom_cnc  %>%  mutate(multc = ifelse(D_814510313_D_814510313_D_939782495==1, 1, 0) + ifelse(D_814510313_D_814510313_D_135725957==1, 1, 0) + ifelse(D_814510313_D_814510313_D_518416174==1, 1, 0) + ifelse(D_814510313_D_814510313_D_847945207==1, 1, 0) + ifelse(D_814510313_D_814510313_D_283025574==1, 1, 0) + ifelse(D_814510313_D_814510313_D_942970912==1, 1, 0) + ifelse(D_814510313_D_814510313_D_596122041==1, 1, 0) + ifelse(D_814510313_D_814510313_D_489400183==1, 1, 0) + ifelse(D_814510313_D_814510313_D_863246236==1, 1, 0) + ifelse(D_814510313_D_814510313_D_607793249==1, 1, 0) + ifelse(D_814510313_D_814510313_D_532172400==1, 1, 0) + ifelse(D_814510313_D_814510313_D_754745617==1, 1, 0) + ifelse(D_814510313_D_814510313_D_665036297==1, 1, 0) + ifelse(D_814510313_D_814510313_D_200837530==1, 1, 0) +  ifelse(D_814510313_D_814510313_D_990319383==1, 1, 0) + ifelse(D_814510313_D_814510313_D_603181162==1, 1, 0) + ifelse(D_814510313_D_814510313_D_482225200==1, 1, 0) + ifelse(D_814510313_D_814510313_D_764891959==1, 1, 0) + ifelse(D_814510313_D_814510313_D_139822395==1, 1, 0) + ifelse(D_814510313_D_814510313_D_487917585==1, 1, 0) + ifelse(D_814510313_D_814510313_D_723614811==1, 1, 0) + ifelse(D_814510313_D_814510313_D_807835037==1, 1, 0) + ifelse(D_814510313_D_814510313_D_178420302==1, 1, 0) )

momcnc= dt_mom_cnc  %>%  mutate(cancer= case_when(as.numeric(multc1)>1 ~ "Multiple Cancer Types",
                                              D_814510313_D_814510313_D_939782495==1 ~ "Anal",
                                             D_814510313_D_814510313_D_135725957==1 ~ "Bladder",
                                             D_814510313_D_814510313_D_518416174==1 ~ "Brain",
                                             D_814510313_D_814510313_D_847945207==1 ~ "Breast",
                                             D_814510313_D_814510313_D_283025574==1 ~ "Cervical",
                                             D_814510313_D_814510313_D_942970912==1 ~ "Colon/Rectal",
                                             D_814510313_D_814510313_D_596122041==1 ~ "Esophageal",
                                             D_814510313_D_814510313_D_489400183==1 ~ "Head, Neck, and Shoulders",
                                             D_814510313_D_814510313_D_863246236==1 ~ "Kidney",
                                             D_814510313_D_814510313_D_607793249==1 ~ "Leukemia",
                                             D_814510313_D_814510313_D_532172400==1 ~ "Liver",
                                             D_814510313_D_814510313_D_754745617==1 ~ "Lung",
                                             D_814510313_D_814510313_D_665036297==1 ~ "Non-Hodgkin's Lymphoma",
                                             D_814510313_D_814510313_D_200837530==1 ~ "Lymphoma",
                                             D_814510313_D_814510313_D_990319383==1 ~ "Melanoma Skin",
                                             D_814510313_D_814510313_D_487917585==1 ~ "Non-Melanoma Skin",
                                             D_814510313_D_814510313_D_603181162==1 ~ "Ovarian",
                                             D_814510313_D_814510313_D_482225200==1 ~ "Pancreatic",
                                             D_814510313_D_814510313_D_764891959==1 ~ "Stomach",
                                             D_814510313_D_814510313_D_139822395==1 ~ "Thyroid",
                                             D_814510313_D_814510313_D_723614811==1 ~ "Uterine",
                                             (D_814510313_D_814510313_D_807835037==1 | !is.na(D_814510313_D_677702321)) ~ "Other",
                                             D_814510313_D_814510313_D_178420302==1 ~ "Unknown",
                                             TRUE ~ "Skipped this question"))

dt_mom_cnc_summary <- momcnc %>%  dplyr::group_by(cancer) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(cancer, n, percentage)

#gt_total_func(dt_mom_cnc_summary, "cancer", "MOMCANC2 Mom's Diagnosed Cancer Type")

dt_mom_cnc_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("MOMCANC2 Mom's Diagnosed Cancer Type")) %>% 
  cols_label(n= md("**N**"), cancer = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = cancer,
    )
  ) 


```





## DADCANC & DADCANC2
```{r DadCancer, warning=FALSE, echo=FALSE, message=FALSE}

#report is quite large, this helps the authentication not time out
bq_auth()

#cancer? 
simple_funct1(D_659784914, "DADCANC: Father Diagnosed with Cancer")



#DADCANC2
#type:
dt_dad_cnc= data_tib_base %>%   filter(D_659784914==353358909) 


dt_dad_cnc <- dt_dad_cnc %>%
  mutate(multc1 = 0)

# Filter columns based on pattern
columns_to_sum <- colnames(dt_dad_cnc)[grepl("D_173240848_D_173240848_", colnames(dt_dad_cnc))]

# Loop through each column and apply the operation
for (col in columns_to_sum) {
  dt_dad_cnc <- dt_dad_cnc %>%
    mutate(multc1 = ifelse(.data[[col]] == 1, 1, 0) + .data$multc1)
}

# dt_dad_cnc= dt_dad_cnc  %>%  mutate(multc = ifelse(D_173240848_D_173240848_D_939782495==1, 1, 0) + ifelse(D_173240848_D_173240848_D_135725957==1, 1, 0) + ifelse(D_173240848_D_173240848_D_518416174==1, 1, 0) + ifelse(D_173240848_D_173240848_D_847945207==1, 1, 0) + ifelse(D_173240848_D_173240848_D_942970912==1, 1, 0) + ifelse(D_173240848_D_173240848_D_596122041==1, 1, 0) + ifelse(D_173240848_D_173240848_D_489400183==1, 1, 0) + ifelse(D_173240848_D_173240848_D_863246236==1, 1, 0) + ifelse(D_173240848_D_173240848_D_607793249==1, 1, 0) + ifelse(D_173240848_D_173240848_D_532172400==1, 1, 0) + ifelse(D_173240848_D_173240848_D_754745617==1, 1, 0) + ifelse(D_173240848_D_173240848_D_665036297==1, 1, 0) + ifelse(D_173240848_D_173240848_D_200837530==1, 1, 0) + ifelse(D_173240848_D_173240848_D_990319383==1, 1, 0) +   ifelse(D_173240848_D_173240848_D_482225200==1, 1, 0) + ifelse(D_173240848_D_173240848_D_764891959==1, 1, 0) + ifelse(D_173240848_D_173240848_D_139822395==1, 1, 0) + ifelse(D_173240848_D_173240848_D_248374037==1, 1, 0) + ifelse(D_173240848_D_173240848_D_807835037==1, 1, 0) + ifelse(D_173240848_D_173240848_D_178420302==1, 1, 0) + ifelse(D_173240848_D_173240848_D_295976386==1, 1, 0) )


dadcnc= dt_dad_cnc  %>%  mutate(cancer= case_when(as.numeric(multc1)>1 ~ "Multiple Cancer Types",
                                                  D_173240848_D_173240848_D_939782495==1 ~ "Anal",
                                             D_173240848_D_173240848_D_135725957==1 ~ "Bladder",
                                             D_173240848_D_173240848_D_518416174==1 ~ "Brain",
                                             D_173240848_D_173240848_D_847945207==1 ~ "Breast",
                                             D_173240848_D_173240848_D_942970912==1 ~ "Colon/Rectal",
                                             D_173240848_D_173240848_D_596122041==1 ~ "Esophageal",
                                             D_173240848_D_173240848_D_489400183==1 ~ "Head, Neck, and Shoulders",
                                             D_173240848_D_173240848_D_863246236==1 ~ "Kidney",
                                             D_173240848_D_173240848_D_607793249==1 ~ "Leukemia",
                                             D_173240848_D_173240848_D_532172400==1 ~ "Liver",
                                             D_173240848_D_173240848_D_754745617==1 ~ "Lung",
                                             D_173240848_D_173240848_D_665036297==1 ~ "Non-Hodgkin's Lymphoma",
                                             D_173240848_D_173240848_D_200837530==1 ~ "Lymphoma",
                                             D_173240848_D_173240848_D_990319383==1 ~ "Melanoma Skin",
                                             D_173240848_D_173240848_D_487917585==1 ~ "Non-Melanoma Skin",
                                             D_173240848_D_173240848_D_482225200==1 ~ "Pancreatic",
                                             D_173240848_D_173240848_D_295976386==1 ~ "Prostate",
                                             D_173240848_D_173240848_D_764891959==1 ~ "Stomach",
                                             D_173240848_D_173240848_D_248374037==1 ~ "Testicular",
                                             D_173240848_D_173240848_D_139822395==1 ~ "Thyroid",
                                             (D_173240848_D_173240848_D_807835037==1 | !is.na(D_173240848_D_195093589)) ~ "Other",
                                             D_173240848_D_173240848_D_178420302==1 ~ "Unknown",
                                             TRUE ~ "Skipped this question"))

dt_dad_cnc_summary <- dadcnc %>% dplyr::group_by(cancer) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(cancer, n, percentage)  

dt_dad_cnc_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("DADCANC2: Father's Diagnosed Cancer Type")) %>% 
  cols_label(n= md("**N**"), cancer = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = cancer,
    )
  ) 

```





## EDU
```{r Edu, warning=FALSE, echo=FALSE, message=FALSE}

data_tib_base$D_367803647_D_367803647 <- factor(data_tib_base$D_367803647_D_367803647, levels=c(978204320,935502060,404564707,432193665,890756124,766964355,875342283,598242454,807835037, "Skipped this Question"))
simple_funct1(D_367803647_D_367803647, "EDU: Highest Level of School Completed")


```

## INCOME
```{r income,  warning=FALSE, echo=FALSE}
data_tib_base$D_759004335 <- factor(data_tib_base$D_759004335, levels=c(374508062,976555124,745561936,209571450,212249150,777814771,922395188,913602274,742032816,178420302,746038746, "Skipped this Question"))
simple_funct1(D_759004335, "INCOME: Total Family Income")


```


## ALTADDRESS1
```{r altadd1, warning=FALSE, echo=FALSE, message=FALSE}

simple_funct1(D_646504105, "ALTADDRESS1: Any Other Mailing Address")


```




























\newpage



```{r merge2, include=FALSE}

#Remove all previous dataframes besides 'merged' to clear up memory
rm(list = setdiff(ls(), c("merged", "data_tib_base", "parts_data", "dict", "project")))



dictionary <- rio::import("https://episphere.github.io/conceptGithubActions/aggregate.json",format = "json")
dd <- dplyr::bind_rows(dictionary,.id="CID")
dd <-rbindlist(dictionary,fill=TRUE,use.names=TRUE,idcol="CID")
dd$`Variable Label`[is.na(dd$`Variable Label`)] <- replace_na(dd$'Variable Name')

dd <- as.data.frame.matrix(do.call("rbind",dictionary)) 
dd$CID <- rownames(dd)
#https://shaivyakodan.medium.com/7-useful-r-packages-for-analysis-7f60d28dca98
#devtools::install_github("tidyverse/reprex")



recr_m2 <- bq_project_query(project, query="SELECT token,Connect_ID, d_821247024, d_914594314,  d_827220437,d_512820379, 
                            d_536735468 , d_517311251  FROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` WHERE  d_821247024='197316935'")
recr_m2 <- bq_table_download(recr_m2,bigint = "integer64",n_max = Inf, page_size = 10000)
cnames <- names(recr_m2)
# Check that it doesn't match any non-number
numbers_only <- function(x) !grepl("\\D", x)
# to check variables in recr_noinact_wl1
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(recr_m2,varname)
  recr_m2[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}




### Deal with Mod2 duplicates (took both version 1 and vesion 2, and only select version 2 data)
sql_M2_1 <- bq_project_query(project, query = "SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module2_v1_JP` WHERE Connect_ID IS NOT NULL")
sql_M2_2 <- bq_project_query(project, query = "SELECT * FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module2_v2_JP` WHERE Connect_ID IS NOT NULL")

M2_V1 <- bq_table_download(sql_M2_1, bigint = "integer64")
M2_V2 <- bq_table_download(sql_M2_2, bigint = "integer64")

# Select matching column names
M2_V1_vars <- colnames(M2_V1)
M2_V2_vars <- colnames(M2_V2)
common_vars <- intersect(M2_V1_vars, M2_V2_vars)

# Subset to common columns
M2_V1_common <- M2_V1[, common_vars]
M2_V2_common <- M2_V2[, common_vars]

# Add version indicator
M2_V1_common$version <- 1
M2_V2_common$version <- 2

# Identify columns with mismatched types
mismatched_cols <- names(M2_V1_common)[sapply(names(M2_V1_common), function(col) {
  class(M2_V1_common[[col]]) != class(M2_V2_common[[col]])
})]

# Convert mismatched columns to character for consistency
M2_V1_common <- M2_V1_common %>%
  mutate(across(all_of(mismatched_cols), as.character))
M2_V2_common <- M2_V2_common %>%
  mutate(across(all_of(mismatched_cols), as.character))

# Combine both versions for participants who completed both
M2_common <- bind_rows(M2_V1_common, M2_V2_common) %>%
  arrange(Connect_ID, desc(version))

# For columns unique to each version
V1_only_vars <- setdiff(M2_V1_vars, common_vars)
V2_only_vars <- setdiff(M2_V2_vars, common_vars)

# Subset each version for unique columns and add version indicator
m2_v1_only <- M2_V1[, c("Connect_ID", V1_only_vars)] %>%
  mutate(version = 1)
m2_v2_only <- M2_V2[, c("Connect_ID", V2_only_vars)] %>%
  mutate(version = 2)

# Combine the unique and common data
M2_common_v1 <- left_join(M2_common, m2_v1_only, by = c("Connect_ID", "version"))
M2_combined_v1v2 <- left_join(M2_common_v1, m2_v2_only, by = c("Connect_ID", "version"))

# Filter for complete cases where specific completion criteria are met
M2_complete <- M2_combined_v1v2 %>%
  filter(Connect_ID %in% recr_m2$Connect_ID[recr_m2$d_536735468 == 231311385]) %>%
  arrange(desc(version))

# Remove duplicates, keeping only the most recent version for each Connect_ID
M2_complete_nodup <- M2_complete[!duplicated(M2_complete$Connect_ID),]
table(M2_complete_nodup$version)


M2_complete_nodup$Connect_ID <- as.numeric(M2_complete_nodup$Connect_ID)


merge_m2= left_join(merged, M2_complete_nodup, by="Connect_ID") 

data_tib_all2 <- as_tibble(merge_m2)

```


```{r funct2, warning=FALSE, echo=FALSE,  message=FALSE, include=FALSE}


#GT table with one filter/skip logic
one_logic_funct2 <- function(CID, CID_prev, Prev_Answer, Title){  
  CID_SYM <- rlang::ensym(CID)
  CID_SYM_P <- rlang::ensym(CID_prev)
  dt_select <- data_tib_all2 %>%  filter(!!CID_SYM_P == Prev_Answer) %>%  select(Connect_ID, !!CID_SYM) 
  gt_yn <- dt_select  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)
  
  gt_yn %>%  gt::gt()  %>%
  fmt_number(columns = "percentage", decimals = 2) %>% 
    fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md(Title)) %>%
  cols_label(n= md("**N**"), answer = md("**Answer**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = answer,
    )
  ) 
}
``` 





## PREG 1
```{r preg, warning=FALSE, echo=FALSE, message=FALSE}
#Currently pregnant

one_logic_funct2(D_849945160,  D_407056417, 536341288, "PREG: Currently Pregnant")

```













\newpage

```{r query3, include=FALSE}

#Remove all previous dataframes besides 'merged' to clear up memory
rm(list = setdiff(ls(), c("merged", "data_tib_base", "parts_data", "dict", "project")))


#Because of the size of the report, authentication has to happen more then once to prevent expiration 
bq_auth()

querymod3 <- "SELECT Connect_ID, D_947205597_D_712653855, D_763164658, D_798549704, D_947205597_D_198133418, D_182431332, D_789271762, D_947205597_D_706254326, D_624111331, D_238422161, D_448968121, D_429228540, D_338467033, D_447720598_D_549079588, D_726847824, D_447720598_D_896953195, D_447720598_D_889023234, D_447720598_D_181769837, D_411088265, D_178665310, D_228752045, D_830608495_D_535003378, D_830608495_D_760521319, D_319397722, D_830608495_D_158841370, D_524914900, D_830608495_D_349034127, D_325229459, D_830608495_D_713594719, D_101170268, D_830608495_D_675129470, D_355689185, D_180308733, D_444759994, D_859228803, D_921663542, D_532755074,  D_633553324_D_294629316, D_556837046_D_141874857, D_480426504, D_633553324_D_164707243, D_633553324_D_771426895, D_633553324_D_818310825, D_633553324_D_843593800, D_633553324_D_175385712, D_633553324_D_772143730 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module3_v1_JP` where Connect_ID IS NOT NULL"
mod3_table <- bq_project_query(project, querymod3)
mod3_data <- bq_table_download(mod3_table, bigint = "integer64")
mod3_data$Connect_ID <- as.numeric(mod3_data$Connect_ID)


data_all3= left_join(parts_data, mod3_data, by="Connect_ID")

data_all3 <- data_all3 %>% filter(d_976570371==231311385)

data_tib_all3 <- as_tibble(data_all3)


```

```{r funct3, warning=FALSE, include=FALSE}
#Created Functions for this code



# #Histogram 
# hist_funct <- function(CID,Title, Xlab, Ylab) {
#   CID_SYM <- rlang::ensym(CID)
#   data_all3 %>% mutate(!!CID_SYM:=as.numeric(!!CID_SYM)) %>%
#     filter(!is.na(!!CID_SYM)) %>%
#     ggplot(aes(x=!!CID_SYM)) + #, fill=as.factor(D_407056417)))+
#     xlab(Xlab) + ylab(Ylab) +  ggtitle(Title)+
#     geom_histogram(color="black")+ scale_y_continuous(breaks=pretty_breaks()) +
#     #scale_fill_discrete(name = "Sex at Birth", labels=c("Female", "Male"))+
#     geom_vline(aes(xintercept=mean(!!CID_SYM, na.rm=T)), colour="#2973A5", linetype="solid")
#   
# }
# 
# 
# #Boxplot
# boxp_funct <- function(CID,Title, Xlab) {
#   CID_SYM <- rlang::ensym(CID)
#   data_all3 %>% mutate(!!CID_SYM:=as.numeric(!!CID_SYM)) %>%
#     filter(!is.na(!!CID_SYM)) %>%
#     ggplot(aes(x=!!CID_SYM)) + #, fill=as.factor(D_407056417)))+
#     xlab(Xlab) + geom_boxplot()+  ggtitle(Title)
#     #scale_fill_discrete(name = "Sex at Birth", labels=c("Female", "Male"))
# }


# #Bar--times used
# bar_totals_funct <- function(CID,Title, Xlab) {
#   CID_SYM <- rlang::ensym(CID)
# data_all3 %>% filter(!is.na(!!CID_SYM)) %>% ggplot(aes(x=!!CID_SYM)) +geom_bar()+ 
#   ggtitle(Title)+xlab(Xlab)+ylab("Frequency") + 
#   #scale_fill_discrete(name = "Sex at Birth", labels=c("Female", "Male")) +
#   scale_x_discrete(labels=c("151488193"="10 or less", 
#                             "805449318"="11-49",
#                             "486319890"="50-99",
#                             "132232896"="100+"))
# }
# 
# #Bar--Frequency used 
# bar_use_funct <- function(CID,Title){
#   CID_SYM <- rlang::ensym(CID)
#   data_all3 %>% filter(!is.na(!!CID_SYM)) %>% ggplot(aes(x=!!CID_SYM)) +geom_bar()+ 
#     ggtitle(Title)+xlab("Frequency")+ylab("Count") +
#     theme(axis.text.x = element_text(angle = 90))+
#     scale_x_discrete(labels=c("419415087"="No, not at all", 
#                               "299561721"="Yes, but rarely",
#                               "716761013"="Yes, but some days",
#                               "804785430"="Yes, every day"))
#     #scale_fill_discrete(name = "Sex at Birth", labels=c("Female", "Male"))
# }
# 
# #Bar--time frame used
# bar_last_funct <- function(CID,Title){
#   CID_SYM <- rlang::ensym(CID)
# data_all3 %>% filter(!is.na(!!CID_SYM)) %>% ggplot(aes(x=!!CID_SYM)) + #, fill=as.factor(D_407056417)))+
#   geom_bar()+ggtitle(Title)+xlab("Time Frame")+ylab("Count") +
#   scale_x_discrete(labels=c("317567178"="In the past month", 
#                             "484055234"="In the past year",
#                             "802197176"="More than a year"))
#   #scale_fill_discrete(name = "Sex at Birth", labels=c("Female", "Male"))
# }
# 
# #Bar--time spent using
# bar_life_A_C_funct <- function(CID,Title){
#   CID_SYM <- rlang::ensym(CID)
#   data_all3 %>% filter(!is.na(!!CID_SYM)) %>%ggplot(aes(x=!!CID_SYM)) + #, fill=as.factor(D_407056417)))+ 
#   ylab("Frequency") + xlab("Time") + geom_bar()+  
#   ggtitle(Title)+
#   scale_x_discrete(labels=c("428999623"="0-14 minutes", 
#                             "248303092"="16-30 min.",
#                             "998679771"="31-59 min.",
#                             "638092100"="1 hr",
#                             "127455035"="2+ hrs"))
#   #scale_fill_discrete(name = "Sex at Birth", labels=c("Female", "Male"))
# }



dict <- list("104430631"="No", "353358909"="Yes", "265550580"="Didn't Drink ", "950039557"="A few times per Year","402048066"="A few times per Month","522395860"="Once per Week",
             "756073829"="A few times per Week","858624942"="Once per day","424768954"="2-3 times per Day","687445652"="4-5 times per Day","333682419"="6+ times per Day", "595249233"="Less Than once per Month ", "637900673"="Once a month","207952166"="2-3 times per Month","198347104"="1-2 times per week","471294296"="3-4 times per Week","594557208"="5-6 times per Week","647504893"="Every Day", "428999623"="0-14 minutes", "248303092"="16-30 min.", "998679771"="31-59 min.","638092100"="1 hr","127455035"="2+ hrs", "419415087"="No, not at all", "299561721"="Yes, but rarely","716761013"="Yes, but some days","804785430"="Yes, every day", "151488193"="10 or less", "805449318"="11-49","486319890"="50-99","132232896"="100+", "317567178"="In the past month", "484055234"="In the past year", "802197176"="More than a year", "759356722" = "One", "185036360" = "More Than One", "684900118" = "I Don't Commute to Work")


##GT TABLE: PRODUCT8C
# funct_8c <- function(PRODUCT8C_CID, PRODUCT5_CID, Product1_CID, Title){  
#   CID_SYM_P1 <- rlang::ensym(Product1_CID)
#   CID_SYM_P8C <- rlang::ensym(PRODUCT8C_CID)
#   CID_SYM_P5 <- rlang::ensym(PRODUCT5_CID)
#   #dt_prod8C <- data_tib_all3[ , c("Connect_ID", !!CID_SYM_P8C, !!CID_SYM_P5, !!CID_SYM_P1)]
#   
#   dt_prod8C <- data_tib_all3 %>%  select(Connect_ID, !!CID_SYM_P8C, !!CID_SYM_P5, !!CID_SYM_P1)
#   gt_prod8C <- dt_prod8C %>% filter((!!CID_SYM_P1==486319890 | !!CID_SYM_P1==132232896) & !!CID_SYM_P5!=317567178) %>% group_by(!!CID_SYM_P8C) %>% 
#     summarize(n=n(), percentage=100*n/nrow(.)) %>% ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM_P8C, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  select(answer, n, percentage)
# 
#   
#   gt_prod8C %>%  gt::gt(rowname_col = "row_lab")  %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% 
#     fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md(Title)) %>% 
#   cols_label(n= md("**N**"), answer = md("**Answer**"), percentage = md("**%**")) %>% 
#   # summary_rows(
#   #   column = c(n, percentage),
#   #   fns= list(
#   #     Sum= ~sum(.)
#   #   ), decimals=0) %>%
#     grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = answer,
#     )
#   ) 
# }



##GT TABLE: PRODUCT9B
# funct_9b <- function(PRODUCT1_CID, PRODUCT4_CID, PRODUCT5_CID, PRODUCT8C_CID, PRODUCT9B_CID, Title){ 
#   CID_SYM_P1 <- rlang::ensym(PRODUCT1_CID)
#   CID_SYM_P4 <- rlang::ensym(PRODUCT4_CID)
#   CID_SYM_P5 <- rlang::ensym(PRODUCT5_CID)
#   CID_SYM_P8C <- rlang::ensym(PRODUCT8C_CID)
#   CID_SYM_P9B <- rlang::ensym(PRODUCT9B_CID)
# 
#   dt_prod9b <- data_tib_all3 %>%  select(Connect_ID, !!CID_SYM_P8C, !!CID_SYM_P4, !!CID_SYM_P5, !!CID_SYM_P1, !!CID_SYM_P9B)
#   gt_prod9b <- dt_prod9b %>% filter((!!CID_SYM_P1==486319890 | !!CID_SYM_P1==132232896) & !(!!CID_SYM_P4== 804785430|
#            ((!is.na(!!CID_SYM_P4) | !!CID_SYM_P4!=419415087) & !!CID_SYM_P5==484055234 & !!CID_SYM_P8C== 353358909) | 
#            ((!is.na(!!CID_SYM_P4) |  !!CID_SYM_P4!=419415087) & !!CID_SYM_P5==802197176 & !!CID_SYM_P8C== 353358909))) %>% 
#     group_by(!!CID_SYM_P9B) %>% 
#     summarize(n=n(), percentage=100*n/nrow(.)) %>% ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM_P9B, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  select(answer, n, percentage)
# 
# 
#   gt_prod9b %>%  gt::gt(rowname_col = "row_lab")  %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% 
#     fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md(Title)) %>% 
#   cols_label(n= md("**N**"), answer = md("**Answer**"), percentage = md("**%**")) %>% 
#   # summary_rows(
#   #   column = c(n, percentage),
#   #   fns= list(
#   #     Sum= ~sum(.)
#   #   ), decimals=0) %>%
#     grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = answer,
#     )
#   ) 
# }


#GT table for questions asked to all (no skip logic)
simple_funct3 <- function(CID, Title, List_of_Levels){  
  CID_SYM <- rlang::ensym(CID)
  dt_select <- data_tib_all3 %>%  select(Connect_ID, !!CID_SYM)
  gt_yn <- dt_select  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% 
    dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)

  gt_yn %>%  gt::gt()  %>%
  fmt_number(columns = "percentage", decimals = 2) %>% 
    fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md(Title)) %>%
  cols_label(n= md("**N**"), answer = md("**Answer**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = answer,
    )
  ) 
}

#GT table with one filter/skip logic
one_logic_funct3 <- function(CID, CID_prev, Prev_Answer, Title){  
  CID_SYM <- rlang::ensym(CID)
  CID_SYM_P <- rlang::ensym(CID_prev)
  dt_select <- data_tib_all3 %>%  filter(!!CID_SYM_P == Prev_Answer) %>%  select(Connect_ID, !!CID_SYM) 
  gt_yn <- dt_select  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% 
    dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)
  
  gt_yn %>%  gt::gt()  %>%
  fmt_number(columns = "percentage", decimals = 2) %>% 
    fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md(Title)) %>%
  cols_label(n= md("**N**"), answer = md("**Answer**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = answer,
    )
  ) 
}



two_logic_funct3 <- function(CID, CID_prev, Prev_Answer, CID_prev2, Prev2_Answer, Title){  
  CID_SYM <- rlang::ensym(CID)
  CID_SYM_P <- rlang::ensym(CID_prev)
  CID_SYM_P2 <- rlang::ensym(CID_prev2)
  dt_select <- data_tib_all3 %>%  filter(!!CID_SYM_P == Prev_Answer | !!CID_SYM_P2 == Prev2_Answer) %>%  select(Connect_ID, !!CID_SYM) 
  gt_yn <- dt_select  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% 
    dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)
  
  gt_yn %>%  gt::gt()  %>%
  fmt_number(columns = "percentage", decimals = 2) %>% 
    fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md(Title)) %>%
  cols_label(n= md("**N**"), answer = md("**Answer**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = answer,
    )
  ) 
}


# ALCLLIFE functions
alclife2_funct <- function(CID, Title){  

  dt_alcl= data_tib_all3  %>%   filter(D_429228540==132232896 & !is.na(D_556837046_D_141874857) & (D_338467033==353358909 | (D_338467033==104430631 & !is.na(D_480426504))))

alcl= dt_alcl  %>%  mutate(oth_age= case_when(CID==265550580 ~"Didn't Drink", 
                                                CID==950039557 ~"A few times per Year",
                                                CID==402048066 ~"A few times per Month",
                                                CID==522395860 ~"Once per Week",
                                                CID==756073829 ~"A few times per Week",
                                                CID==858624942 ~"Once per day",
                                                CID==424768954 ~"2-3 times per Day",
                                                CID==687445652 ~"4-5 times per Day",
                                                CID==333682419 ~"6+ times per Day",
                                              TRUE ~ "Skipped this question"))
alcl$oth_age <- factor(alcl$oth_age,levels=c("Didn't Drink","A few times per Year","A few times per Month","Once per Week", "A few times per Week","Once per day","2-3 times per Day","4-5 times per Day","6+ times per Day","Skipped this question"))

dt_alcl_summary <- alcl %>% dplyr::group_by(oth_age) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(oth_age, n, percentage) 

dt_alcl_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md(Title)) %>% 
  cols_label(n= md("**N**"), oth_age = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(stub.font.weight = "bold") %>%
  tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = oth_age,)) 
}



#GT table with two filters/skip logics----this one is having issues
# two_logic_funct <- function(CID, CID_prev, Prev_Answer, Prev_Answer_two, Title){  
#   CID_SYM <- rlang::ensym(CID)
#   CID_SYM_P <- rlang::ensym(CID_prev)
#   dt_select <- data_tib_m3 %>%  filter((!!CID_SYM_P == Prev_Answer) | (!!CID_SYM_P == Prev_Answer_two)) %>%  select(Connect_ID, !!CID_SYM) 
#   gt_yn <- dt_select  %>% group_by(!!CID_SYM) %>% summarize(n=n(), percentage=100*n/nrow(.)) %>% ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% 
#     replace_na(list(answer="Skipped this Question")) %>%  select(answer, percentage)
#   
#   gt_yn %>%  gt::gt(rowname_col = "row_lab")  %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md(Title)) %>% 
#   cols_label(answer = md("**Answer**"), percentage = md("**%**")) %>% 
#   summary_rows(
#     column = c(participants,percentage),
#     fns= list(
#       Sum= ~sum(.)
#     ), decimals=0) %>%
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = answer,
#     )
#   ) 
# }
# two_logic_funct(D_790436165_D_79043616, D_763164658, 486319890, 132232896, "CIG3_never: Smoking on a Regular Basis")
# 
# data_tib_m3_CIG <- data_tib_m3 %>%  filter(data_tib_m3$D_763164658==486319890| data_tib_m3$D_763164658==132232896)
# 
# dt_cig3 <- data_tib_m3_CIG[ , c("Connect_ID", "D_790436165_D_790436165_D_648960871")] 
# 
# dtCIG3= dt_cig3 %>%  mutate(participants=rep(1, dim(dt_cig3)[[1]]))
# 
# dtCIG3$percentage= (dtCIG3$participants/dim(dtCIG3)[[1]])*100 
# #dtCIG3= dtCIG3 %>%  mutate(percentage=(dtCIG3$participants/dim(dtCIG3)[[1]])*100) <--- doesn't work to avoid error message
# 
# 
# cig3_ans= dtCIG3 %>%  mutate(answer= case_when(D_790436165_D_790436165_D_648960871=="[]" ~ "Answered with age",
#                                              D_790436165_D_790436165_D_648960871=="[648960871]" ~ "Never smoked on a regular basis",
#                                              is.na(D_790436165_D_790436165_D_648960871) ~ "Skipped this question"))
# 
# dtCIG3_summary <- cig3_ans %>% group_by(answer) %>%   summarize_at(c("participants","percentage"), sum, na.rm = TRUE) 
# gtm3_print <- gt::gt(dtCIG3_summary)
# #gtm3_print
# 
# dtCIG3_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md("CIG3_never: Smoking on a Regular Basis")) %>% 
#   cols_label(answer = md("**Answer**"), percentage = md("**%**")) %>% 
#   summary_rows(
#     column = c(participants,percentage),
#     fns= list(
#       Sum= ~sum(.)
#     ), decimals=0) %>%
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = answer,
#     )
#   ) 

```


## Frequency of Cigarette Smoking

```{r cigerette, echo=FALSE, warning=FALSE, message=FALSE}

cig_frequency= data_tib_all3  %>% 
  mutate(often= case_when((D_947205597_D_712653855==0 | (D_947205597_D_712653855==1 & (D_763164658==151488193| D_763164658==805449318)))~"Never a Cigarette Smoker",
                             (D_947205597_D_712653855==1 & (D_763164658==486319890| D_763164658==132232896) & D_798549704==317567178)~"Currently a Cigarette Smoker",
                             (D_947205597_D_712653855==1 & (D_763164658==486319890| D_763164658==132232896)  & (D_798549704==484055234 | D_798549704==802197176))~"Formerly a Cigarette Smoker",
                             TRUE~"Skipped all these questions"))

dt_cig_frequency_summary <- cig_frequency %>% group_by(often) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(often, n, percentage)


dt_cig_frequency_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Frequency of Cigarette Smoking")) %>% 
  cols_label(n= md("**N**"), often = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
    stub.font.weight = "bold"
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = often,
    )
  ) 


```



## Frequency of Cigar Smoking

```{r cigar, echo=FALSE, warning=FALSE, message=FALSE}


cigar_frequency= data_tib_all3  %>% 
  mutate(often= case_when(D_947205597_D_198133418==0 | (D_947205597_D_198133418==1 & (D_182431332==151488193| D_182431332==805449318))~"Never a Cigar Smoker",
                             D_947205597_D_198133418==1 & (D_182431332==486319890| D_182431332==132232896) & D_798549704==317567178~"Currently a Cigar Smoker",
                             D_947205597_D_198133418==1 & (D_182431332==486319890| D_182431332==132232896)  & (D_789271762==484055234 | D_789271762==802197176)~"Formerly a Cigar Smoker",
                             TRUE~"Skipped all These Questions"))



dt_cigar_frequency_summary <- cigar_frequency %>% group_by(often) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(often, n, percentage)

dt_cigar_frequency_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Frequency of Cigar Smoking")) %>% 
  cols_label(n= md("**N**"), often = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
    stub.font.weight = "bold"
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = often,
    )
  ) 


```




## Frequency of E-cig Smoking

```{r ecig, echo=FALSE, warning=FALSE, message=FALSE}


e_cig_frequency= data_tib_all3  %>% 
  mutate(often= case_when(D_947205597_D_706254326==0 | (D_947205597_D_706254326==1 & (D_624111331==151488193| D_624111331==805449318))~"Never a E-cigarette Smoker",
                             D_947205597_D_706254326==1 & (D_624111331==486319890| D_624111331==132232896) & D_238422161==317567178~"Currently a E-cigarette Smoker",
                             D_947205597_D_706254326==1 & (D_624111331==486319890| D_624111331==132232896)  & (D_238422161==484055234 | D_238422161==802197176)~"Formerly a E-cigarette Smoker",
                             TRUE~"Skipped all These Questions"))



dt_e_cig_frequency_summary <- e_cig_frequency %>% group_by(often) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(often, n, percentage)

dt_e_cig_frequency_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Frequency of Electronic Cigarette Smoking")) %>% 
  cols_label(n= md("**N**"), often = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
    stub.font.weight = "bold"
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = often,
    )
  ) 


```





## Frequency of Cannabis Use

```{r cannabis, echo=FALSE, warning=FALSE, message=FALSE}


mj_frequency= data_tib_all3  %>% 
  mutate(often= case_when((D_830608495_D_535003378==1 | (D_830608495_D_760521319==1 & (D_319397722==151488193| D_319397722==805449318))) |
                            (D_830608495_D_158841370==1 & (D_524914900==151488193| D_524914900==805449318)) |
                            (D_830608495_D_349034127==1 & (D_325229459==151488193| D_325229459==805449318)) |
                            (D_830608495_D_713594719==1 & (D_101170268==151488193| D_101170268==805449318)) | 
                            (D_830608495_D_675129470==1 & (D_355689185==151488193| D_355689185==805449318)) ~"Never a Cannabis Smoker",
                          (D_830608495_D_760521319==1 & (D_319397722==486319890| D_319397722==132232896) & D_180308733==317567178) |
                            (D_830608495_D_158841370==1 & (D_524914900==486319890| D_524914900==132232896) & D_444759994==317567178) |
                            (D_830608495_D_349034127==1 & (D_325229459==486319890| D_325229459==132232896) & D_859228803==317567178) |
                            (D_830608495_D_713594719==1 & (D_101170268==486319890| D_101170268==132232896) & D_921663542==317567178) |
                            (D_830608495_D_675129470==1 & (D_355689185==486319890| D_355689185==132232896) & D_532755074==317567178) ~"Currently a Cannabis Smoker",
                          (D_830608495_D_760521319==1 & (D_319397722==486319890| D_319397722==132232896)  & (D_180308733==484055234 | D_180308733==802197176)) |
                            (D_830608495_D_158841370==1 & (D_524914900==486319890| D_524914900==132232896)  & (D_444759994==484055234 | D_444759994==802197176)) |
                            (D_830608495_D_349034127==1 & (D_325229459==486319890| D_325229459==132232896)  & (D_859228803==484055234 | D_859228803==802197176)) |
                            (D_830608495_D_713594719==1 & (D_101170268==486319890| D_101170268==132232896)  & (D_921663542==484055234 | D_921663542==802197176)) |
                            (D_830608495_D_675129470==1 & (D_355689185==486319890| D_355689185==132232896)  & (D_532755074==484055234 | D_532755074==802197176)) ~"Formerly a Cannabis Smoker",
                             TRUE~"Skipped all These Questions"))



dt_mj_frequency_summary <- mj_frequency %>% group_by(often) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(often, n, percentage)

dt_mj_frequency_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Frequency of Cannabis Smoking")) %>% 
  cols_label(n= md("**N**"), often = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
    stub.font.weight = "bold"
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = often,
    )
  ) 
```


## ALCLIFE2, ALCLIFE5
```{r alclife25, warning=FALSE, echo=FALSE, message=FALSE}

#ALCOHOL2
data_tib_all3$D_429228540 <- factor(data_tib_all3$D_429228540,levels=c(151488193, 805449318, 486319890, 132232896, "Skipped this Question"))
one_logic_funct3(D_429228540,D_448968121, 353358909, "ALCOHOL2: Alcoholic Beverages in a Lifetime")


#ALCOHOL5
two_logic_funct3(D_338467033,D_429228540, 486319890, D_429228540, 132232896, "ALCOHOL5: Consumed an Alcoholic Beverage in the Last 12 Months")


```

## BEER1
```{r beer1, warning=FALSE, echo=FALSE, message=FALSE}

data_tib_all3$D_726847824 <- factor(data_tib_all3$D_726847824,levels=c(595249233, 637900673,207952166,198347104,471294296,594557208,647504893, "Skipped this Question"))
one_logic_funct3(D_726847824,D_447720598_D_549079588, 1, "BEER1: Frequency of Drinking Beer/Hard Cider in the Last Year")


```

## LIQUOR1
```{r liquor1, warning=FALSE, echo=FALSE, message=FALSE}


one_logic_funct3(D_411088265, D_447720598_D_896953195, 1, "LIQUOR1: Frequency of Drinking Liquor of Mixed Drinks in the Last Year")


```

## WINE1
```{r wine1, warning=FALSE, echo=FALSE, message=FALSE}

one_logic_funct3(D_178665310, D_447720598_D_889023234,1,"WINE1: Frequency of Drinking Wine in the Last Year")



```

## OTHERALC1
```{r otheralc1, warning=FALSE, echo=FALSE, message=FALSE}


one_logic_funct3(D_228752045,D_447720598_D_181769837,1, "OTHERALC1: Frequency of Drinking Other Alcoholic Beverages in the Last Year")

```


## ALCLIFEA-H
```{r alclife, warning=FALSE, echo=FALSE, message=FALSE}
##ALCLIFE2 GRID
#ALCLIFE2A
#alclife2_funct(D_633553324_D_294629316,"ALCLIFE2A: Frequency of Drinking: Ages 0-17")


#### COMPLICATED SKIP LOGIC
  # DERIVED AGE VARIABLE PUSHED TO PROD AFTER MOD3 RELEASE, SO WE CAN'T USE IT-- needed to create one below
# ALC2=3, ALC4 IS NOT NA, & (ALC5=1 OR (ALC5=0 & ALC6 IS NOT NA)) AND (ALC4<ALCLIFEAGE & (ALCLIFEAGE<ALC6 | AGE>ALCLIFEAGE))
                                                                        # IF THEY NEVER STOPPED DRINKING, THEN AGE STARTED<ALCLIFE, IF STOPPED TEHN STARTED<ALCLIFE AND ALCLIFE<AGESTOPPED


data_tib_all3$DOB <- paste0(data_all3$d_544150384, "-", data_all3$d_564964481, "-", data_all3$d_795827569) 
data_tib_all3$DOB <- as.Date(data_tib_all3$DOB) #, format='%y-%m-%d')
currentDate <- as.Date(Sys.Date(), format='%y/%m/%d')


data_tib_all3$AGEGRID <- time_length(difftime(currentDate, data_tib_all3$DOB), "years")



dt_alcl= data_tib_all3  %>%   filter(data_tib_all3$D_429228540==132232896 & !is.na(data_tib_all3$D_556837046_D_141874857) & 
                                       (data_tib_all3$D_338467033==353358909 | (data_tib_all3$D_338467033==104430631 & !is.na(data_tib_all3$D_480426504))) & 
                                       ((is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<17) | 
                                          (!is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<17 & as.numeric(data_tib_all3$D_480426504)>17)))
                                          # (as.numeric(data_tib_all3$D_480426504)>17 | (is.na(data_tib_all3$D_48042650) & (data_tib_all3$state_d_934298480==124276120 |data_tib_all3$state_d_934298480==450985724 |
                                          #                                                                                   data_tib_all3$state_d_934298480==363147933 | 
                                          #                                                                                   data_tib_all3$state_d_934298480==636706443 |data_tib_all3$state_d_934298480==771230670))) ))

alcl= dt_alcl  %>%  mutate(oth_age= case_when(D_633553324_D_294629316==265550580 ~"Didn't Drink", 
                                                D_633553324_D_294629316==950039557 ~"A few times per Year",
                                                D_633553324_D_294629316==402048066 ~"A few times per Month",
                                                D_633553324_D_294629316==522395860 ~"Once per Week",
                                                D_633553324_D_294629316==756073829 ~"A few times per Week",
                                                D_633553324_D_294629316==858624942 ~"Once per day",
                                                D_633553324_D_294629316==424768954 ~"2-3 times per Day",
                                                D_633553324_D_294629316==687445652 ~"4-5 times per Day",
                                                D_633553324_D_294629316==333682419 ~"6+ times per Day",
                                              TRUE ~ "Skipped this question"))
alcl$oth_age <- factor(alcl$oth_age,levels=c("Didn't Drink","A few times per Year","A few times per Month","Once per Week", "A few times per Week","Once per day","2-3 times per Day","4-5 times per Day","6+ times per Day","Skipped this question"))

dt_alcl_summary <- alcl %>% dplyr::group_by(oth_age) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(oth_age, n, percentage) 

dt_alcl_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("ALCLIFE2A: Frequency of Drinking: Ages 0-17")) %>% 
  cols_label(n= md("**N**"), oth_age = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(stub.font.weight = "bold") %>%
  tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = oth_age,)) 

#ALCLIFE2B
#alclife2_funct(D_633553324_D_164707243,"ALCLIFE2B: Frequency of Drinking: Ages 18-24")
#grid.arrange(alclf2A, alclf2B, nrow=2)


dt_alcl= data_tib_all3  %>%   filter(data_tib_all3$D_429228540==132232896 & !is.na(data_tib_all3$D_556837046_D_141874857) & 
                                       (data_tib_all3$D_338467033==353358909 | (data_tib_all3$D_338467033==104430631 & !is.na(data_tib_all3$D_480426504))) & 
                                       ((is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<24) | 
                                          (!is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<24 & as.numeric(data_tib_all3$D_480426504)>24)))
                                          # (as.numeric(data_tib_all3$D_480426504)>17 | (is.na(data_tib_all3$D_48042650) & (data_tib_all3$state_d_934298480==124276120 |data_tib_all3$state_d_934298480==450985724 |
                                          #                                                                                   data_tib_all3$state_d_934298480==363147933 | 
                                          #                                                                                   data_tib_all3$state_d_934298480==636706443 |data_tib_all3$state_d_934298480==771230670))) ))

alcl= dt_alcl  %>%  mutate(oth_age= case_when(D_633553324_D_164707243==265550580 ~"Didn't Drink", 
                                                D_633553324_D_164707243==950039557 ~"A few times per Year",
                                                D_633553324_D_164707243==402048066 ~"A few times per Month",
                                                D_633553324_D_164707243==522395860 ~"Once per Week",
                                                D_633553324_D_164707243==756073829 ~"A few times per Week",
                                                D_633553324_D_164707243==858624942 ~"Once per day",
                                                D_633553324_D_164707243==424768954 ~"2-3 times per Day",
                                                D_633553324_D_164707243==687445652 ~"4-5 times per Day",
                                                D_633553324_D_164707243==333682419 ~"6+ times per Day",
                                              TRUE ~ "Skipped this question"))
alcl$oth_age <- factor(alcl$oth_age,levels=c("Didn't Drink","A few times per Year","A few times per Month","Once per Week", "A few times per Week","Once per day","2-3 times per Day","4-5 times per Day","6+ times per Day","Skipped this question"))

dt_alcl_summary <- alcl %>% dplyr::group_by(oth_age) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(oth_age, n, percentage) 

dt_alcl_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("ALCLIFE2B: Frequency of Drinking: Ages 18-24")) %>% 
  cols_label(n= md("**N**"), oth_age = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(stub.font.weight = "bold") %>%
  tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = oth_age,)) 


#ALCLIFE2C
#alclife2_funct(D_633553324_D_771426895,"ALCLIFE2C: Frequency of Drinking: Ages 25-29")
dt_alcl= data_tib_all3  %>%   filter(data_tib_all3$D_429228540==132232896 & !is.na(data_tib_all3$D_556837046_D_141874857) & 
                                       (data_tib_all3$D_338467033==353358909 | (data_tib_all3$D_338467033==104430631 & !is.na(data_tib_all3$D_480426504))) & 
                                       ((is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<29) | 
                                          (!is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<29 & as.numeric(data_tib_all3$D_480426504)>29)))
                                          # (as.numeric(data_tib_all3$D_480426504)>17 | (is.na(data_tib_all3$D_48042650) & (data_tib_all3$state_d_934298480==124276120 |data_tib_all3$state_d_934298480==450985724 |
                                          #                                                                                   data_tib_all3$state_d_934298480==363147933 | 
                                          #                                                                                   data_tib_all3$state_d_934298480==636706443 |data_tib_all3$state_d_934298480==771230670))) ))

alcl= dt_alcl  %>%  mutate(oth_age= case_when(D_633553324_D_771426895==265550580 ~"Didn't Drink", 
                                                D_633553324_D_771426895==950039557 ~"A few times per Year",
                                                D_633553324_D_771426895==402048066 ~"A few times per Month",
                                                D_633553324_D_771426895==522395860 ~"Once per Week",
                                                D_633553324_D_771426895==756073829 ~"A few times per Week",
                                                D_633553324_D_771426895==858624942 ~"Once per day",
                                                D_633553324_D_771426895==424768954 ~"2-3 times per Day",
                                                D_633553324_D_771426895==687445652 ~"4-5 times per Day",
                                                D_633553324_D_771426895==333682419 ~"6+ times per Day",
                                              TRUE ~ "Skipped this question"))
alcl$oth_age <- factor(alcl$oth_age,levels=c("Didn't Drink","A few times per Year","A few times per Month","Once per Week", "A few times per Week","Once per day","2-3 times per Day","4-5 times per Day","6+ times per Day","Skipped this question"))

dt_alcl_summary <- alcl %>% dplyr::group_by(oth_age) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(oth_age, n, percentage) 

dt_alcl_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("ALCLIFE2C: Frequency of Drinking: Ages 25-29")) %>% 
  cols_label(n= md("**N**"), oth_age = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(stub.font.weight = "bold") %>%
  tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = oth_age,)) 

#ALCLIFE2D
#alclife2_funct(D_633553324_D_818310825,"ALCLIFE2D: Frequency of Drinking: Ages 30-39")
dt_alcl= data_tib_all3  %>%   filter(data_tib_all3$D_429228540==132232896 & !is.na(data_tib_all3$D_556837046_D_141874857) & 
                                       (data_tib_all3$D_338467033==353358909 | (data_tib_all3$D_338467033==104430631 & !is.na(data_tib_all3$D_480426504))) & 
                                       ((is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<39) | 
                                          (!is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<39 & as.numeric(data_tib_all3$D_480426504)>39)))
                                          # (as.numeric(data_tib_all3$D_480426504)>17 | (is.na(data_tib_all3$D_48042650) & (data_tib_all3$state_d_934298480==124276120 |data_tib_all3$state_d_934298480==450985724 |
                                          #                                                                                   data_tib_all3$state_d_934298480==363147933 | 
                                          #                                                                                   data_tib_all3$state_d_934298480==636706443 |data_tib_all3$state_d_934298480==771230670))) ))

alcl= dt_alcl  %>%  mutate(oth_age= case_when(D_633553324_D_818310825==265550580 ~"Didn't Drink", 
                                                D_633553324_D_818310825==950039557 ~"A few times per Year",
                                                D_633553324_D_818310825==402048066 ~"A few times per Month",
                                                D_633553324_D_818310825==522395860 ~"Once per Week",
                                                D_633553324_D_818310825==756073829 ~"A few times per Week",
                                                D_633553324_D_818310825==858624942 ~"Once per day",
                                                D_633553324_D_818310825==424768954 ~"2-3 times per Day",
                                                D_633553324_D_818310825==687445652 ~"4-5 times per Day",
                                                D_633553324_D_818310825==333682419 ~"6+ times per Day",
                                              TRUE ~ "Skipped this question"))
alcl$oth_age <- factor(alcl$oth_age,levels=c("Didn't Drink","A few times per Year","A few times per Month","Once per Week", "A few times per Week","Once per day","2-3 times per Day","4-5 times per Day","6+ times per Day","Skipped this question"))

dt_alcl_summary <- alcl %>% dplyr::group_by(oth_age) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(oth_age, n, percentage) 

dt_alcl_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("ALCLIFE2D: Frequency of Drinking: Ages 30-39")) %>% 
  cols_label(n= md("**N**"), oth_age = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(stub.font.weight = "bold") %>%
  tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = oth_age,)) 




#ALCLIFE2E
#alclife2_funct(D_633553324_D_843593800,"ALCLIFE2E: Frequency of Drinking: Ages 40-49")
dt_alcl= data_tib_all3  %>%   filter(data_tib_all3$AGEGRID>40 & data_tib_all3$D_429228540==132232896 & !is.na(data_tib_all3$D_556837046_D_141874857) & 
                                       (data_tib_all3$D_338467033==353358909 | (data_tib_all3$D_338467033==104430631 & !is.na(data_tib_all3$D_480426504))) & 
                                       ((is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<49) | 
                                          (!is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<49 & as.numeric(data_tib_all3$D_480426504)>49)))
                                          # (as.numeric(data_tib_all3$D_480426504)>17 | (is.na(data_tib_all3$D_48042650) & (data_tib_all3$state_d_934298480==124276120 |data_tib_all3$state_d_934298480==450985724 |
                                          #                                                                                   data_tib_all3$state_d_934298480==363147933 | 
                                          #                                                                                   data_tib_all3$state_d_934298480==636706443 |data_tib_all3$state_d_934298480==771230670))) ))

alcl= dt_alcl  %>%  mutate(oth_age= case_when(D_633553324_D_843593800==265550580 ~"Didn't Drink", 
                                                D_633553324_D_843593800==950039557 ~"A few times per Year",
                                                D_633553324_D_843593800==402048066 ~"A few times per Month",
                                                D_633553324_D_843593800==522395860 ~"Once per Week",
                                                D_633553324_D_843593800==756073829 ~"A few times per Week",
                                                D_633553324_D_843593800==858624942 ~"Once per day",
                                                D_633553324_D_843593800==424768954 ~"2-3 times per Day",
                                                D_633553324_D_843593800==687445652 ~"4-5 times per Day",
                                                D_633553324_D_843593800==333682419 ~"6+ times per Day",
                                              TRUE ~ "Skipped this question"))
alcl$oth_age <- factor(alcl$oth_age,levels=c("Didn't Drink","A few times per Year","A few times per Month","Once per Week", "A few times per Week","Once per day","2-3 times per Day","4-5 times per Day","6+ times per Day","Skipped this question"))

dt_alcl_summary <- alcl %>% dplyr::group_by(oth_age) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(oth_age, n, percentage) 

dt_alcl_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>%
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("ALCLIFE2E: Frequency of Drinking: Ages 40-49")) %>% 
  cols_label(n= md("**N**"), oth_age = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(stub.font.weight = "bold") %>%
  tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = oth_age,)) 

#ALCLIFE2F
#alclife2_funct(D_633553324_D_175385712,"ALCLIFE2F: Frequency of Drinking: Ages 50-59")
dt_alcl= data_tib_all3  %>%   filter(data_tib_all3$AGEGRID>50 & data_tib_all3$D_429228540==132232896 & !is.na(data_tib_all3$D_556837046_D_141874857) & 
                                       (data_tib_all3$D_338467033==353358909 | (data_tib_all3$D_338467033==104430631 & !is.na(data_tib_all3$D_480426504))) & 
                                       ((is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<59) | 
                                          (!is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<59 & as.numeric(data_tib_all3$D_480426504)>59)))
                                          # (as.numeric(data_tib_all3$D_480426504)>17 | (is.na(data_tib_all3$D_48042650) & (data_tib_all3$state_d_934298480==124276120 |data_tib_all3$state_d_934298480==450985724 |
                                          #                                                                                   data_tib_all3$state_d_934298480==363147933 | 
                                          #                                                                                   data_tib_all3$state_d_934298480==636706443 |data_tib_all3$state_d_934298480==771230670))) ))

alcl= dt_alcl  %>%  mutate(oth_age= case_when(D_633553324_D_175385712==265550580 ~"Didn't Drink", 
                                                D_633553324_D_175385712==950039557 ~"A few times per Year",
                                                D_633553324_D_175385712==402048066 ~"A few times per Month",
                                                D_633553324_D_175385712==522395860 ~"Once per Week",
                                                D_633553324_D_175385712==756073829 ~"A few times per Week",
                                                D_633553324_D_175385712==858624942 ~"Once per day",
                                                D_633553324_D_175385712==424768954 ~"2-3 times per Day",
                                                D_633553324_D_175385712==687445652 ~"4-5 times per Day",
                                                D_633553324_D_175385712==333682419 ~"6+ times per Day",
                                              TRUE ~ "Skipped this question"))
alcl$oth_age <- factor(alcl$oth_age,levels=c("Didn't Drink","A few times per Year","A few times per Month","Once per Week", "A few times per Week","Once per day","2-3 times per Day","4-5 times per Day","6+ times per Day","Skipped this question"))

dt_alcl_summary <- alcl %>% dplyr::group_by(oth_age) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(oth_age, n, percentage) 

dt_alcl_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("ALCLIFE2F: Frequency of Drinking: Ages 50-59")) %>% 
  cols_label(n= md("**N**"), oth_age = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(stub.font.weight = "bold") %>%
  tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = oth_age,)) 


#ALCLIFE2G
#alclife2_funct(D_633553324_D_772143730,"ALCLIFE2G: Frequency of Drinking: Ages 60-69")
dt_alcl= data_tib_all3  %>%   filter(data_tib_all3$AGEGRID>60 & data_tib_all3$D_429228540==132232896 & !is.na(data_tib_all3$D_556837046_D_141874857) & 
                                       (data_tib_all3$D_338467033==353358909 | (data_tib_all3$D_338467033==104430631 & !is.na(data_tib_all3$D_480426504))) & 
                                       ((is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<69) | 
                                          (!is.na(data_tib_all3$D_480426504) & as.numeric(data_tib_all3$D_556837046_D_141874857)<69 & as.numeric(data_tib_all3$D_480426504)>69)))
                                          # (as.numeric(data_tib_all3$D_480426504)>17 | (is.na(data_tib_all3$D_48042650) & (data_tib_all3$state_d_934298480==124276120 |data_tib_all3$state_d_934298480==450985724 |
                                          #                                                                                   data_tib_all3$state_d_934298480==363147933 | 
                                          #                                                                                   data_tib_all3$state_d_934298480==636706443 |data_tib_all3$state_d_934298480==771230670))) ))

alcl= dt_alcl  %>%  mutate(oth_age= case_when(D_633553324_D_772143730==265550580 ~"Didn't Drink", 
                                                D_633553324_D_772143730==950039557 ~"A few times per Year",
                                                D_633553324_D_772143730==402048066 ~"A few times per Month",
                                                D_633553324_D_772143730==522395860 ~"Once per Week",
                                                D_633553324_D_772143730==756073829 ~"A few times per Week",
                                                D_633553324_D_772143730==858624942 ~"Once per day",
                                                D_633553324_D_772143730==424768954 ~"2-3 times per Day",
                                                D_633553324_D_772143730==687445652 ~"4-5 times per Day",
                                                D_633553324_D_772143730==333682419 ~"6+ times per Day",
                                              TRUE ~ "Skipped this question"))
alcl$oth_age <- factor(alcl$oth_age,levels=c("Didn't Drink","A few times per Year","A few times per Month","Once per Week", "A few times per Week","Once per day","2-3 times per Day","4-5 times per Day","6+ times per Day","Skipped this question"))

dt_alcl_summary <- alcl %>% dplyr::group_by(oth_age) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(oth_age, n, percentage) 

dt_alcl_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("ALCLIFE2G: Frequency of Drinking: Ages 60-69")) %>% 
  cols_label(n= md("**N**"), oth_age = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(stub.font.weight = "bold") %>%
  tab_style(style = list(cell_text(weight = "bold")),
            locations = cells_body(columns = oth_age,)) 

#ALCLIFE2H-- no one yet
# alclife2_funct(D_633553324_D_602102163,"ALCLIFE2A: Frequency of Drinking: Ages 70+")


```
























\newpage

```{r query4, include=FALSE}

#Remove all previous dataframes besides 'merged' to clear up memory
rm(list = setdiff(ls(), c("merged", "data_tib_base", "dict", "project")))


#Because of the size of the report, authentication has to happen more then once to prevent expiration 
bq_auth()

querymod4 <- "SELECT Connect_ID, D_980007418, D_995620555, D_828801156, D_374639590, D_694113343, D_121490150_D_255248624, D_121490150_D_945532934, D_121490150_D_469838242, D_121490150_D_303500597, D_121490150_D_195068098, D_121490150_D_202784871, D_121490150_D_831127170, D_290969423, D_869829679, D_574985342_D_985267931, D_574985342_D_111275683, D_574985342_D_536516743, D_574985342_D_283900560, D_574985342_D_467947502, D_574985342_D_368486703, D_862052821, D_845483079, D_828086036_D_875706715, D_828086036_D_645150792, D_828086036_D_588699608, D_828086036_D_544692849, D_828086036_D_335435992, D_828086036_D_337088272, D_593146348, D_736086261, D_680046149_D_130174162, D_680046149_D_563832508, D_680046149_D_930511603, D_680046149_D_756548442, D_680046149_D_455968200, D_680046149_D_728704613, D_983592172, D_294308065, D_274189667_D_838725845, D_274189667_D_565515774, D_274189667_D_742177990, D_274189667_D_843508307, D_274189667_D_554901696, D_274189667_D_819429013, D_776406200, D_385583361, D_113930886_D_306805272, D_113930886_D_819844467, D_113930886_D_418702418, D_113930886_D_101219440, D_113930886_D_127963610, D_113930886_D_882731998, D_135207939, D_768802173, D_809728747_D_351559015, D_809728747_D_903490632, D_809728747_D_703944664, D_809728747_D_390463636, D_809728747_D_256790385, D_809728747_D_915222355 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module4_v1_JP` where Connect_ID IS NOT NULL"

mod4_table <- bq_project_query(project, querymod4)
mod4_data <- bq_table_download(mod4_table, bigint = "integer64")
mod4_data$Connect_ID <- as.numeric(mod4_data$Connect_ID)

merge_m4P= left_join(merged, mod4_data, by="Connect_ID") 

data_all4 <- merge_m4P %>% filter(d_663265240==231311385)

data_tib_all4 <- as_tibble(data_all4)




Mod4 <- as_tibble(data_tib_all4)

```


```{r functions4, include=FALSE}


simple_funct4 <- function(CID, Title){  
  CID_SYM <- rlang::ensym(CID)
  dt_select <- data_tib_all4 %>%  select(Connect_ID, !!CID_SYM)
  gt_yn <- data_tib_all4  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% 
    dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)


  gt_yn %>%  gt::gt()  %>%
  fmt_number(columns = "percentage", decimals = 2) %>% 
    fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md(Title)) %>%
  cols_label(n= md("**N**"), answer = md("**Answer**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = answer,
    )
  ) 
}


one_logic_funct4 <- function(CID, CID_prev, Prev_Answer, Title){  
  CID_SYM <- rlang::ensym(CID)
  CID_SYM_P <- rlang::ensym(CID_prev)
  dt_select <- data_tib_all4 %>%  filter(!!CID_SYM_P == Prev_Answer) %>%  select(Connect_ID, !!CID_SYM) 
  gt_yn <- dt_select  %>% dplyr::group_by(!!CID_SYM) %>% dplyr::summarize(n=n(), percentage=100*n/nrow(.)) %>% 
    dplyr::ungroup() %>% dplyr::mutate(answer=recode(!!CID_SYM, !!!dict)) %>% replace_na(list(answer="Skipped this Question")) %>%  dplyr::select(answer, n, percentage)
  
  gt_yn %>%  gt::gt()  %>%
  fmt_number(columns = "percentage", decimals = 2) %>% 
    fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md(Title)) %>%
  cols_label(n= md("**N**"), answer = md("**Answer**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = answer,
    )
  ) 
}


```


## WORK2019
```{r work19, echo=FALSE, warning=FALSE, message=FALSE}

simple_funct4(D_694113343, "WORK2019: Work for Pay in 2019")
  

```


## WORKRES
```{r workres, echo=FALSE, warning=FALSE, message=FALSE}


one_logic_funct4(D_374639590, D_694113343, 353358909, "WORKRES: Daily Work Tasks Include Driving")


```



## NUMWORK
```{r numwork, echo=FALSE, warning=FALSE, message=FALSE}

dt_NUMWORK= data_tib_all4 %>%  filter(D_374639590!=353358909)

NUMWORK= dt_NUMWORK %>%  mutate(meds= case_when(D_828801156==759356722 ~ "One",
                                               D_828801156==185036360 ~ "More Than One",
                                               D_828801156==684900118 ~ "I Don't Commute to Work",
                                               TRUE  ~ "Skipped this question"))


dtNUMWORK_summary <- NUMWORK %>% group_by(meds) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(meds, n, percentage)


dtNUMWORK_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("NUMWORK: Number of Workplaces You Currently Commute to")) %>% 
  cols_label(n= md("**N**"), meds = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
    stub.font.weight = "bold"
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = meds,
    )
  ) 

```


## PREWORK
```{r prework, echo=FALSE, warning=FALSE, message=FALSE}

simple_funct4(D_995620555, "PREWORK: Commuted to Work at Least Once a Week in the Last 20 Years")


```



## PREWORKRES
```{r preworkres, echo=FALSE, warning=FALSE, message=FALSE}

one_logic_funct4(D_980007418, D_995620555, 353358909, "PREWORKRES: Daily Responsibilities of Longest Held Job Include Driving")

```














```{r map4, echo=FALSE, warning=FALSE, message=FALSE}
## Map of Current Addresses-- currently removing as it breaks the automation 


# library(ggmap)
# library(maps)
# library(mapdata)
# library(sf)
# library(zipcodeR)
# library(viridis)
# library(ggthemes)
# #library(albersusa)
# 
# states <- map_data("state")
# us_base <- ggplot(data = states) +
#   geom_polygon(aes(x = long, y = lat, fill = region, group = group), color = "white") +
#   coord_fixed(1.3) +
#   guides(fill=FALSE)  # do this to leave off the color legend
# 
# 
# ca_base <- ggplot(data = states, mapping = aes(x = long, y = lat, group = group)) + 
#   coord_fixed(1.3) + 
#   geom_polygon(color = "black", fill = "gray")
# #ca_base + theme_nothing()
# 
# 
# # Example with zip codes : https://stackoverflow.com/questions/59801437/is-there-an-r-package-that-can-take-zipcodes-and-create-a-heat-map-of-the-united
# 
# 
# #Attempt 1
#  zipc_heat <- data_tib_all4 %>% mutate(ZIP= str_sub(data_tib_all4$D_121490150_D_202784871,1,5),
#                                        State= D_121490150_D_195068098)
# 
#  zipc_heat <- zipc_heat %>%  select(ZIP) %>%  filter(!is.na(ZIP) & ZIP!="Gfchh" & str_sub(ZIP,1,1)!=" " & str_sub(ZIP,1,2)!="  " & str_sub(ZIP,5,5)!=" " & str_sub(ZIP,4,5)!="  ") ## need to remove the 4 digit zip code and random letter zip code
# 
#  #zipc_heat$ZIP <- as.numeric(zipc_heat$ZIP)
# 
#  ZP_HT <- as.data.frame(table(zipc_heat))
# 
# 
#  #ZP_HT$ZIP<- clean.zipcodes(ZP_HT$ZIP)
#  ZP_HT_US<-aggregate(data.frame(count=ZP_HT$Freq),list(zip=ZP_HT$ZIP),length)
# 
# 
#  
# # EXAMPLE OF PER COUNTY GRAPH OF JUST CA- have to figure out how to add counties of all countries and populations equal to our participant population 
#    # https://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html
#   #https://jtr13.github.io/cc19/different-ways-of-plotting-u-s-map-in-r.html
#  #https://www.sharpsightlabs.com/blog/how-to-create-a-crime-heatmap-in-r/
#  #https://rpubs.com/jcraggy/841199
#  
#  zip_to_lat_lon_North America.csv
#  #Attemp1 10 
#  zip_to_lat_lon_North.America <- read.csv("C:/Users/dowlingk2/Downloads/zip_to_lat_lon_North_America.csv")
#  all_zips <- zip_to_lat_lon_North.America %>%  filter(Country=="United States" & (postal.code %in%  ZP_HT_US$zip)) 
#  all_zips$ZIP <- all_zips$postal.code
# us_zip <- left_join(ZP_HT, all_zips, by="ZIP")
# us_zip$lat <- us_zip$latitude
# us_zip$long <- us_zip$longitude
# us_zip <- us_zip %>% filter(!is.na(state))
# us_zip$state <- tolower(us_zip$state)
# 
# state_group <- states %>% select(group, region)
# state_group$state <- state_group$region
# 
# usa_zip <- left_join(us_zip, state_group, by="state")

# 
# 
# 
# ditch_the_axes <- theme(
#   axis.text = element_blank(),
#   axis.line = element_blank(),
#   axis.ticks = element_blank(),
#   panel.border = element_blank(),
#   panel.grid = element_blank(),
#   axis.title = element_blank()
#   )
#  
# elbow_room1 <- ca_base + 
#       geom_polygon(data = usa_zip, aes(fill = Freq), color = "white") +

#       geom_polygon(color = "black", fill = NA) +
#       theme_bw() +
#       ditch_the_axes
# 
# eb2 <- elbow_room1 + 
#     scale_fill_gradientn(colours = rev(rainbow(7)),
#                          breaks = c(2, 4, 10, 100, 1000, 10000),
#                          trans = "log10")
# 
# 
# eb2 + xlim(-125, -67.1) + ylim(25,50)
# 
#  
# 
#  
#  
#  #Attempt 8

```


## Home Addresses
```{r HomeAddress, warning=FALSE, echo=FALSE, message=FALSE}


  home1skip <- Mod4 %>% select(Connect_ID, D_121490150_D_255248624, D_121490150_D_945532934, D_121490150_D_303500597, D_121490150_D_195068098, D_121490150_D_202784871, D_121490150_D_831127170)
  home1skip= home1skip %>%  mutate(Address1= case_when(!is.na(D_121490150_D_255248624) | !is.na(D_121490150_D_945532934) | !is.na(D_121490150_D_303500597) | 
                                                         !is.na(D_121490150_D_195068098) | !is.na(D_121490150_D_202784871) |!is.na(D_121490150_D_831127170)~"Provided Current Address",
                                                       TRUE ~ "Skipped All Address Components"))

dt_home1skip_summary <- home1skip %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)

dt_home1skip_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Address 1- Current Address")) %>% 
  cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = Address1,
    )
  ) 






home2 <- Mod4 %>% filter(D_290969423==353358909| D_869829679==270752953) %>% 
  mutate(Address1= case_when(!is.na(D_574985342_D_985267931) | !is.na(D_574985342_D_111275683) | !is.na(D_574985342_D_536516743) | 
                                                     !is.na(D_574985342_D_283900560) | !is.na(D_574985342_D_467947502) |!is.na(D_574985342_D_368486703)~"Provided Address",
                                                       TRUE ~ "Skipped All Address Components"))

dt_home2_summary <- home2 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)

dt_home2_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Address 2- First Previous Home")) %>% 
  cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = Address1,
    )
  ) 






home3 <- Mod4 %>% filter(D_862052821==353358909| D_845483079==270752953) %>%  
  mutate(Address1= case_when(!is.na(D_828086036_D_875706715) | !is.na(D_828086036_D_645150792) | !is.na(D_828086036_D_588699608) | 
                                                     !is.na(D_828086036_D_544692849) | !is.na(D_828086036_D_335435992) |!is.na(D_828086036_D_337088272)~"Provided Address",
                                                       TRUE ~ "Skipped All Address Components"))

dt_home3_summary <- home3 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)

dt_home3_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Address 3- Second Previous Home")) %>% 
  cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = Address1,
    )
  ) 





home4 <- Mod4 %>%  filter(D_593146348==353358909 | D_736086261==270752953) %>%  
  mutate(Address1= case_when(!is.na(D_680046149_D_130174162) | !is.na(D_680046149_D_563832508) | !is.na(D_680046149_D_930511603) | 
                                                     !is.na(D_680046149_D_756548442) | !is.na(D_680046149_D_455968200) |!is.na(D_680046149_D_728704613)~"Provided Address",
                                                       TRUE ~ "Skipped All Address Components"))

dt_home4_summary <- home4 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)

dt_home4_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Address 4- Third Previous Home")) %>% 
  cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = Address1,
    )
  ) 



home5 <- Mod4 %>% filter(D_983592172==353358909 | D_294308065==270752953) %>%  
  mutate(Address1= case_when(!is.na(D_274189667_D_838725845) | !is.na(D_274189667_D_565515774) | !is.na(D_274189667_D_742177990) | 
                                                     !is.na(D_274189667_D_843508307) | !is.na(D_274189667_D_554901696) |!is.na(D_274189667_D_819429013)~"Provided Address",
                                                       TRUE ~ "Skipped All Address Components"))

dt_home5_summary <- home5 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)

dt_home5_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Address 5- Fourth Previous Home")) %>% 
  cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = Address1,
    )
  ) 




home6 <- Mod4 %>% filter(D_776406200==353358909 | D_385583361==270752953) %>%  
  mutate(Address1= case_when(!is.na(D_113930886_D_306805272) | !is.na(D_113930886_D_819844467) | !is.na(D_113930886_D_418702418) | 
                                                     !is.na(D_113930886_D_101219440) | !is.na(D_113930886_D_127963610) |!is.na(D_113930886_D_882731998)~"Provided Address",
                                                       TRUE ~ "Skipped All Address Components"))

dt_home6_summary <- home6 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)

dt_home6_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Address 6- Fifth Previous Home")) %>% 
  cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = Address1,
    )
  ) 



home7 <- Mod4 %>% filter(D_135207939==353358909 | D_768802173==270752953) %>%  
  mutate(Address1= case_when(!is.na(D_809728747_D_351559015) | !is.na(D_809728747_D_903490632) | !is.na(D_809728747_D_703944664) | 
                                                     !is.na(D_809728747_D_390463636) | !is.na(D_809728747_D_256790385) |!is.na(D_809728747_D_915222355)~"Provided Address",
                                                       TRUE ~ "Skipped All Address Components"))

dt_home7_summary <- home7 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)

dt_home7_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Address 7- Sixth Previous Home")) %>% 
  cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = Address1,
    )
  ) 


# home8 <- Mod4 %>% filter(D_647612167==353358909 | D_150560299==270752953) %>%  
#   mutate(Address1= case_when(!is.na(D_539057792_D_893639464) | !is.na(D_539057792_D_438475588) | !is.na(D_539057792_D_744290061) | 
#                                                      !is.na(D_539057792_D_516936572) | !is.na(D_539057792_D_673034401) |!is.na(D_539057792_D_489019597)~"Provided Address",
#                                                        TRUE ~ "Skipped All Address Components"))
# 
# dt_home8_summary <- home8 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)
# 
# dt_home8_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% 
#   fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md("Address 8- Seventh Previous Home")) %>% 
#   cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
#   grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = Address1,
#     )
#   ) 
# 
# 
# home9 <- Mod4 %>% filter(D_532944666==353358909 | D_122054737==270752953) %>%  
#   mutate(Address1= case_when(!is.na(D_537011756_D_988266183) | !is.na(D_537011756_D_709374950) | !is.na(D_537011756_D_351559021) | 
#                                                      !is.na(D_537011756_D_290370013) | !is.na(D_537011756_D_453691095) |!is.na(D_537011756_D_202104231)~"Provided Address",
#                                                        TRUE ~ "Skipped All Address Components"))
# 
# dt_home9_summary <- home9 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)
# 
# dt_home9_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% 
#   fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md("Address 9- Eighth Previous Home")) %>% 
#   cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
#   grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = Address1,
#     )
#   ) 
# 
# 
# home10 <- Mod4 %>% filter(D_548863580==353358909 | D_948492967==270752953) %>%  
#   mutate(Address1= case_when(!is.na(D_171937884_D_264707783) | !is.na(D_171937884_D_666011940) | !is.na(D_171937884_D_282089547) | 
#                                                      !is.na(D_171937884_D_612617245) | !is.na(D_171937884_D_674024553) |!is.na(D_171937884_D_886247195)~"Provided Address",
#                                                        TRUE ~ "Skipped All Address Components"))
# 
# dt_home10_summary <- home10 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)
# 
# dt_home10_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% 
#   fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md("Address 10- Ninth Previous Home")) %>% 
#   cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
#   grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = Address1,
#     )
#   ) 
# 
# 
# home11 <- Mod4 %>% filter(D_124320444==353358909 | D_805353966==270752953) %>%  
#   mutate(Address1= case_when(!is.na(D_828766803_D_622968789) | !is.na(D_828766803_D_696874548) | !is.na(D_828766803_D_309461541) | 
#                                                      !is.na(D_828766803_D_789637860) | !is.na(D_828766803_D_795253129) |!is.na(D_828766803_D_780298998)~"Provided Address",
#                                                        TRUE ~ "Skipped All Address Components"))
# 
# dt_home11_summary <- home11 %>% dplyr::group_by(Address1) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(Address1, n, percentage)
# 
# dt_home11_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
#   fmt_number(columns = "percentage", decimals = 2) %>% 
#   fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
#   tab_header(title = md("Address 11- Tenth Previous Home")) %>% 
#   cols_label(n= md("**N**"),Address1 = md("**Answer**"), percentage = md("**%**")) %>% 
#   grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
#   tab_options(
#       stub.font.weight = "bold"
#     ) %>%
#   tab_style(
#     style = list(
#       cell_text(weight = "bold")
#     ),
#     locations = cells_body(
#       columns = Address1,
#     )
#   ) 
# 


```




\newpage

# QC/Operational Metrics
Objectives of enrollment and survey operational metrics: Identify trends and issues related to enrollment and the completion of baseline activities that require prompt resolution by the Operations team, Qx Subcommittee, DevOps team, and sites. 

## SSN
```{r ssn, warning=FALSE,echo=FALSE, message=FALSE}





ssn_surv = data_tib_base %>%  mutate(started=case_when(d_126331570==615768760 ~ "Started",
                                                d_126331570==231311385 ~ "Submitted",
                                                TRUE ~ "Not Started"))

ssn_surv_summary <- ssn_surv  %>% dplyr::group_by(started) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(started, n, percentage) 


ssn_surv_summary_gt <- ssn_surv_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Status of the SSN Suvery")) %>% 
  cols_label(n= md("**N**"), started = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = started,
    )
  )   #
tab_footnote(
  ssn_surv_summary_gt,
  md("The SSN Survey Completion Flag was created after the SSN Survey had opened. There are additional participants with no flag that have given a SSN. Those will be included in the next table."),
  locations = cells_column_labels(columns = started),
  placement = c("left")
)

# ssn_surv_summary[(dim(ssn_surv_summary)[[1]] + 1), ] <- c("Total", sum(ssn_surv_summary$n), sum(ssn_surv_summary$percentage))
# ssn_surv_summary[3,1] <- c("Test", "Test", "Test")
# ssn_surv_summary[4,] <- c("Total", 1, 2)


ssn_stsb= data_tib_base %>%  filter(!is.na(d_914639140) | !is.na(d_311580100)) # (ssn_surv== 615768760 | ssn_surv==  231311385)


gavePssn = ssn_stsb %>%  mutate(provided4=case_when(d_914639140==353358909 ~ "Partial SSN Given",
                                                    d_311580100==353358909 ~ "Full SSN Given",
                                                   TRUE ~ "No SSN given"),
                                Completion= case_when(d_100767870==353358909 & (d_878865966==353358909 | d_684635302==353358909 |
                                                                                  d_167958071==353358909)~ "Fully Enrolled",
                                              d_100767870==353358909 ~ "All Baseline Modules",
                                              d_100767870==104430631 & d_878865966==104430631 & d_684635302==104430631 & 
                                                d_167958071==104430631 ~ "No Baseline Activities",
                                              d_100767870==104430631 & (d_878865966==353358909 | d_684635302==353358909 |
                                                                          d_167958071==353358909) ~ "Any Baseline Sample"))
                                                    #TRUE ~ "Fully Enrolled"))

gavePssn$Completion <- factor(gavePssn$Completion,levels=c("No Baseline Activities", "Any Baseline Sample", "All Baseline Modules",
                                                           "Fully Enrolled"))
gavePssn$provided4 <- factor(gavePssn$provided4,levels=c("Partial SSN Given", "Full SSN Given", "No SSN given"))

gavePssn %>% dplyr::select(Completion, provided4)  %>% tbl_cross(
  row = Completion,
  col = provided4,
  percent = "row",
  digits=c(0,2),
  label=list(Completion~"Completion", provided4~" "), 
  missing="ifany",
  missing_text="Unknown") %>%
  bold_labels() %>% 
  modify_header() %>%
  modify_caption("Portion of SSN Given for Submitted SSN Surveys") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

```


## Age at Enrollment
```{r age, warning=FALSE,echo=FALSE}

which_age= data_tib_base %>%  mutate(age= case_when(state_d_934298480==124276120 ~ "Age 40-45",
                                             state_d_934298480==450985724 ~ "Age 46-50",
                                             state_d_934298480==363147933 ~ "Age 51-55",
                                             state_d_934298480==636706443 ~ "Age 56-60",
                                             state_d_934298480==771230670 ~ "Age 61-65",
                                             !is.na(D_150344905) ~ "Answered with Corrected Age in Mod1",
                                             TRUE  ~ "Skipped this question"))

dt_all_ages_summary <- which_age  %>% dplyr::group_by(age) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(age, n, percentage)  


dt_all_ages_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("Age of Participants at Recruitment")) %>% 
  cols_label(n= md("**N**"), age = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = age,
    )
  ) 

```


## SIBCANC & SIBCANC2
```{r sibcan, warning=FALSE, echo=FALSE, message=FALSE}
#SIBCANC


sibcanc1= data_tib_base  %>%  filter(as.numeric(D_694265648) >0) %>%  mutate(status= case_when((D_607773106_1_1==353358909 | D_607773106_2_2==353358909 | 
                                      D_607773106_3_3==353358909 | D_607773106_4_4==353358909 | D_607773106_5_5==353358909 | D_607773106_6_6==353358909 |
                                      D_607773106_7_7==353358909| D_607773106_8_8==353358909 | D_607773106_9_9==353358909| D_607773106_10_10==353358909 |
                                      D_607773106_11_11==353358909 | D_607773106_12_12==353358909  | D_607773106_13_13==353358909)  ~ "Sibling Diagnosed",
                                      (D_607773106_1_1==104430631 | D_607773106_2_2==104430631 | 
                                      D_607773106_3_3==104430631 | D_607773106_4_4==104430631 | D_607773106_5_5==104430631 | D_607773106_6_6==104430631 |
                                      D_607773106_7_7==104430631| D_607773106_8_8==104430631 | D_607773106_9_9==104430631| D_607773106_10_10==104430631 |
                                      D_607773106_11_11==104430631 | D_607773106_12_12==104430631  | D_607773106_13_13==104430631)  ~ "No Sibling Diagnosed",
                                                    TRUE ~ "Skipped This Question"))

dt_sibcanc1_summary <- sibcanc1 %>% dplyr::group_by(status) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(status, n, percentage) 


dt_sibcanc1_summary %>%  gt::gt(rowname_col = "row_lab") %>%  ## why is this not a proper gt_tbl??
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("SIBCANC: Siblings 1-13 Diagnosed with Cancer")) %>%
  cols_label(status = md("**Answer**"), n = md("**N**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = status,
    )
  ) 




#SIBCANC2
#type:

sibling <- sibcanc1 %>%  filter(status=="Sibling Diagnosed")

sibling <- sibling %>%
  mutate(multc1 = 0)

# Filter columns based on pattern
columns_to_sum <- colnames(sibling)[grepl("D_578895128_", colnames(sibling))]

# Loop through each column and apply the operation
for (col in columns_to_sum) {
  sibling <- sibling %>%
    mutate(multc1 = ifelse(.data[[col]] == 1, 1, 0) + .data$multc1)
}



body_sibling= sibling  %>%  mutate(bodyp= case_when(as.numeric(multc1)>1  ~ "Multiple Cancer Types",
                                                    (D_578895128_2_2_D_578895128_2_2_D_939782495==1 | D_578895128_1_1_D_578895128_1_1_D_939782495==1 | D_578895128_3_3_D_578895128_3_3_D_939782495==1 | D_578895128_4_4_D_578895128_4_4_D_939782495==1) ~ "Anal",
                                                 (D_578895128_2_2_D_578895128_2_2_D_135725957==1 | D_578895128_1_1_D_578895128_1_1_D_135725957==1 | D_578895128_3_3_D_578895128_3_3_D_135725957==1 | D_578895128_4_4_D_578895128_4_4_D_135725957==1) ~ "Bladder",
                                                 (D_578895128_2_2_D_578895128_2_2_D_518416174==1 | D_578895128_1_1_D_578895128_1_1_D_518416174==1 | D_578895128_3_3_D_578895128_3_3_D_518416174==1 | D_578895128_4_4_D_578895128_4_4_D_518416174==1) ~ "Brain",
                                                 (D_578895128_2_2_D_578895128_2_2_D_847945207==1 | D_578895128_1_1_D_578895128_1_1_D_847945207==1 | D_578895128_3_3_D_578895128_3_3_D_847945207==1 | D_578895128_4_4_D_578895128_4_4_D_847945207==1) ~ "Breast",
                                                 (D_578895128_2_2_D_578895128_2_2_D_942970912==1 | D_578895128_1_1_D_578895128_1_1_D_942970912==1 | D_578895128_3_3_D_578895128_3_3_D_942970912==1 | D_578895128_4_4_D_578895128_4_4_D_942970912==1) ~ "Colon/Rectal",
                                                 (D_578895128_2_2_D_578895128_2_2_D_596122041==1 | D_578895128_1_1_D_578895128_1_1_D_596122041==1 | D_578895128_3_3_D_578895128_3_3_D_596122041==1 | D_578895128_4_4_D_578895128_4_4_D_596122041==1) ~ "Esophageal",
                                                 (D_578895128_2_2_D_578895128_2_2_D_489400183==1 | D_578895128_1_1_D_578895128_1_1_D_489400183==1 | D_578895128_3_3_D_578895128_3_3_D_489400183==1 | D_578895128_4_4_D_578895128_4_4_D_489400183==1) ~ "Head, Neck, and Shoulders",
                                                 (D_578895128_2_2_D_578895128_2_2_D_863246236==1 | D_578895128_1_1_D_578895128_1_1_D_863246236==1 | D_578895128_3_3_D_578895128_3_3_D_863246236==1 | D_578895128_4_4_D_578895128_4_4_D_863246236==1) ~ "Kidney",
                                                 (D_578895128_2_2_D_578895128_2_2_D_607793249==1 | D_578895128_1_1_D_578895128_1_1_D_607793249==1 | D_578895128_3_3_D_578895128_3_3_D_607793249==1 | D_578895128_4_4_D_578895128_4_4_D_607793249==1) ~ "Leukemia",
                                                 (D_578895128_2_2_D_578895128_2_2_D_532172400==1 | D_578895128_1_1_D_578895128_1_1_D_532172400==1 | D_578895128_3_3_D_578895128_3_3_D_532172400==1 | D_578895128_4_4_D_578895128_4_4_D_532172400==1) ~ "Liver",
                                                 (D_578895128_2_2_D_578895128_2_2_D_754745617==1 | D_578895128_1_1_D_578895128_1_1_D_754745617==1 | D_578895128_3_3_D_578895128_3_3_D_754745617==1 | D_578895128_4_4_D_578895128_4_4_D_754745617==1) ~ "Lung",
                                                 (D_578895128_2_2_D_578895128_2_2_D_665036297==1 | D_578895128_1_1_D_578895128_1_1_D_665036297==1 | D_578895128_3_3_D_578895128_3_3_D_665036297==1 | D_578895128_4_4_D_578895128_4_4_D_665036297==1) ~ "Non-Hodgkin's Lymphoma",
                                                 (D_578895128_2_2_D_578895128_2_2_D_200837530==1 | D_578895128_1_1_D_578895128_1_1_D_200837530==1 | D_578895128_3_3_D_578895128_3_3_D_200837530==1 | D_578895128_4_4_D_578895128_4_4_D_200837530==1) ~ "Lymphoma",
                                                 (D_578895128_2_2_D_578895128_2_2_D_990319383==1 | D_578895128_1_1_D_578895128_1_1_D_990319383==1  | D_578895128_3_3_D_578895128_3_3_D_990319383==1 | D_578895128_4_4_D_578895128_4_4_D_990319383==1) ~ "Melanoma Skin",
                                                 (D_578895128_2_2_D_578895128_2_2_D_487917585==1 | D_578895128_1_1_D_578895128_1_1_D_487917585==1 | D_578895128_3_3_D_578895128_3_3_D_487917585==1 | D_578895128_4_4_D_578895128_4_4_D_487917585==1) ~ "Non-Melanoma Skin",
                                                 (D_578895128_2_2_D_578895128_2_2_D_482225200==1 | D_578895128_1_1_D_578895128_1_1_D_482225200==1 | D_578895128_3_3_D_578895128_3_3_D_482225200==1 | D_578895128_4_4_D_578895128_4_4_D_482225200==1) ~ "Pancreatic",
                                                 (D_578895128_2_2_D_578895128_2_2_D_295976386==1 | D_578895128_1_1_D_578895128_1_1_D_295976386==1 | D_578895128_3_3_D_578895128_3_3_D_295976386==1 | D_578895128_4_4_D_578895128_4_4_D_295976386==1) ~ "Prostate",
                                                 (D_578895128_2_2_D_578895128_2_2_D_764891959==1 | D_578895128_1_1_D_578895128_1_1_D_764891959==1 | D_578895128_3_3_D_578895128_3_3_D_764891959==1  | D_578895128_4_4_D_578895128_4_4_D_764891959==1) ~ "Stomach",
                                                 (D_578895128_2_2_D_578895128_2_2_D_248374037==1 | D_578895128_1_1_D_578895128_1_1_D_248374037==1 | D_578895128_3_3_D_578895128_3_3_D_248374037==1 | D_578895128_4_4_D_578895128_4_4_D_248374037==1) ~ "Testicular",
                                                 (D_578895128_2_2_D_578895128_2_2_D_139822395==1 | D_578895128_1_1_D_578895128_1_1_D_139822395==1 | D_578895128_3_3_D_578895128_3_3_D_139822395==1 | D_578895128_4_4_D_578895128_4_4_D_139822395==1) ~ "Thyroid",
                                                 ((D_578895128_1_1_D_578895128_1_1_D_807835037==1 | D_578895128_2_2_D_578895128_2_2_D_807835037==1 | D_578895128_3_3_D_578895128_3_3_D_807835037==1 | D_578895128_4_4_D_578895128_4_4_D_807835037==1 | !is.na(D_578895128_1_1_D_957429734_1) | !is.na(D_578895128_2_2_D_957429734_2) | !is.na(D_578895128_3_3_D_957429734_3) | !is.na(D_578895128_4_4_D_957429734_4))) ~ "Other",
                                                 (D_578895128_1_1_D_578895128_1_1_D_178420302==1 | D_578895128_2_2_D_578895128_2_2_D_178420302==1 | D_578895128_3_3_D_578895128_3_3_D_178420302==1 | D_578895128_4_4_D_578895128_4_4_D_178420302==1) ~ "Unknown", 
                                                 TRUE ~ "Skipped this Question"))
                                 
dt_body_sibling_summary <- body_sibling %>% dplyr::group_by(bodyp) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(bodyp, percentage)  

sibling_bd_canc <- dt_body_sibling_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "bodyp", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("SIBCANC2: Type of Cancer Sibling 1-4 Diagnosed With")) %>% 
  cols_label(bodyp = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = bodyp,
    )
  ) 

sibling_bd_canc


```



## CHILDCANC & CHILDCANC2
```{r childcanc, warning=FALSE, echo=FALSE, message=FALSE}

#CHILDCANC
# CHILDcanc1= data_tib_base  %>%  filter(as.numeric(D_446999144) >0) %>%  mutate(status= case_when((D_718867914_1_1==353358909 |D_718867914_2_2==353358909 | D_718867914_3_3==353358909 | 
#                                                                                                     D_718867914_4_4==353358909 | D_718867914_5_5==353358909 |
#                                       D_718867914_6_6==353358909 | D_718867914_7_7==353358909 | D_718867914_8_8==353358909 | D_718867914_9_9==353358909 |
#                                       D_718867914_10_10==353358909) ~ "Child Diagnosed",
#                                       (D_718867914_1_1==104430631  | D_718867914_2_2==104430631 | D_718867914_3_3==104430631 | D_718867914_4_4==104430631 | D_718867914_5_5==104430631 &
#                                       D_718867914_6_6==104430631 | D_718867914_7_7==104430631 | D_718867914_8_8==104430631 | D_718867914_9_9==104430631 |
#                                       D_718867914_10_10==104430631) ~ "No Child Diagnosed",
#                                                     TRUE ~ "Skipped This Question"))

CHILDcanc1= data_tib_base  %>%  filter(as.numeric(D_446999144) >0) %>%  mutate(status= case_when((D_718867914_1_1==353358909 |D_718867914_2_2==353358909 | D_718867914_3_3==353358909 | 
                                                                                                    D_718867914_4_4==353358909 | D_718867914_5_5==353358909 |
                                      D_718867914_6_6==353358909 | D_718867914_7_7==353358909 | D_718867914_8_8==353358909 | D_718867914_9_9==353358909 |
                                      D_718867914_10_10==353358909) ~ "Child Diagnosed",
                                      (is.na(D_718867914_1_1) | (as.numeric(D_446999144) >1 & is.na(D_718867914_2_2)) | (as.numeric(D_446999144) >2 & is.na(D_718867914_3_3)) | (as.numeric(D_446999144) >3 & is.na(D_718867914_4_4)) | (as.numeric(D_446999144) >4 & is.na(D_718867914_5_5)) |(as.numeric(D_446999144) >5 & is.na(D_718867914_6_6)) | (as.numeric(D_446999144) >6 & is.na(D_718867914_7_7)) | (as.numeric(D_446999144) >7  & is.na(D_718867914_8_8))  | (as.numeric(D_446999144) >8 & is.na(D_718867914_9_9)) |
                                      (as.numeric(D_446999144) >9 & is.na(D_718867914_10_10))) ~ "Skipped this Question",
                                                    TRUE ~ "No Child Diagnosed"))

dt_CHILDcanc1_summary <- CHILDcanc1 %>% dplyr::group_by(status) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(status, n, percentage) 


dt_CHILDcanc1_summary %>%  gt::gt(rowname_col = "row_lab") %>%  ## why is this not a proper gt_tbl??
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "n", decimals=0, use_seps = TRUE) %>%
  tab_header(title = md("CHILDCANC: Children 1-10 Diagnosed with Cancer")) %>%
  cols_label(status = md("**Answer**"), n = md("**N**"), percentage = md("**%**")) %>%
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = status,
    )
  ) 


#CHILCANC2

kid <- CHILDcanc1 %>%  filter(status=="Child Diagnosed")

kid <- kid %>%
  mutate(multc1 = 0)

# Filter columns based on pattern
columns_to_sum <- colnames(kid)[grepl("D_812370563_", colnames(kid))]

# Loop through each column and apply the operation
for (col in columns_to_sum) {
  kid <- kid %>%
    mutate(multc1 = ifelse(.data[[col]] == 1, 1, 0) + .data$multc1)
}

body_kid= kid  %>%  mutate(bodyp= case_when(as.numeric(multc1)>1  ~ "Multiple Cancer Types",
                                            (D_812370563_1_1_D_812370563_1_1_D_939782495==1 | D_812370563_2_2_D_812370563_2_2_D_939782495==1 | D_812370563_3_3_D_812370563_3_3_D_939782495==1 | D_812370563_4_4_D_812370563_4_4_D_939782495==1) ~ "Anal",
                                                     (D_812370563_1_1_D_812370563_1_1_D_135725957==1 | D_812370563_2_2_D_812370563_2_2_D_135725957==1 | D_812370563_3_3_D_812370563_3_3_D_135725957==1 | D_812370563_4_4_D_812370563_4_4_D_135725957==1) ~ "Bladder",
                                                     (D_812370563_1_1_D_812370563_1_1_D_518416174==1 | D_812370563_2_2_D_812370563_2_2_D_518416174==1 | D_812370563_3_3_D_812370563_3_3_D_518416174==1 | D_812370563_4_4_D_812370563_4_4_D_518416174==1) ~ "Brain",
                                                     (D_812370563_1_1_D_812370563_1_1_D_847945207==1 | D_812370563_2_2_D_812370563_2_2_D_847945207==1 | D_812370563_3_3_D_812370563_3_3_D_847945207==1 | D_812370563_4_4_D_812370563_4_4_D_847945207==1) ~ "Breast",
                                                     (D_812370563_1_1_D_812370563_1_1_D_283025574==1 | D_812370563_2_2_D_812370563_2_2_D_283025574==1 | D_812370563_3_3_D_812370563_3_3_D_283025574==1 | D_812370563_4_4_D_812370563_4_4_D_283025574==1) ~ "Cerivical",
                                                     (D_812370563_1_1_D_812370563_1_1_D_942970912==1 | D_812370563_2_2_D_812370563_2_2_D_942970912==1 | D_812370563_3_3_D_812370563_3_3_D_942970912==1 | D_812370563_4_4_D_812370563_4_4_D_942970912==1) ~ "Colon/Rectal",
                                                     (D_812370563_1_1_D_812370563_1_1_D_596122041==1 | D_812370563_2_2_D_812370563_2_2_D_596122041==1 | D_812370563_3_3_D_812370563_3_3_D_596122041==1 | D_812370563_4_4_D_812370563_4_4_D_596122041==1 ) ~ "Esophageal",
                                                     (D_812370563_1_1_D_812370563_1_1_D_489400183==1 | D_812370563_2_2_D_812370563_2_2_D_489400183==1 | D_812370563_3_3_D_812370563_3_3_D_489400183==1 | D_812370563_4_4_D_812370563_4_4_D_489400183==1) ~ "Head, Neck, and Shoulders",
                                                     (D_812370563_1_1_D_812370563_1_1_D_863246236==1 | D_812370563_2_2_D_812370563_2_2_D_863246236==1 | D_812370563_3_3_D_812370563_3_3_D_863246236==1 | D_812370563_4_4_D_812370563_4_4_D_863246236==1) ~ "Kidney",
                                                     (D_812370563_1_1_D_812370563_1_1_D_607793249==1 | D_812370563_2_2_D_812370563_2_2_D_607793249==1 | D_812370563_3_3_D_812370563_3_3_D_607793249==1 | D_812370563_4_4_D_812370563_4_4_D_607793249==1) ~ "Leukemia",
                                                     (D_812370563_1_1_D_812370563_1_1_D_532172400==1 | D_812370563_2_2_D_812370563_2_2_D_532172400==1 | D_812370563_3_3_D_812370563_3_3_D_532172400==1 | D_812370563_4_4_D_812370563_4_4_D_532172400==1 ) ~ "Liver", 
                                                     (D_812370563_1_1_D_812370563_1_1_D_754745617==1 | D_812370563_2_2_D_812370563_2_2_D_754745617==1 | D_812370563_3_3_D_812370563_3_3_D_754745617==1 | D_812370563_4_4_D_812370563_4_4_D_754745617==1 ) ~ "Lung",
                                                     (D_812370563_1_1_D_812370563_1_1_D_665036297==1 | D_812370563_2_2_D_812370563_2_2_D_665036297==1 | D_812370563_3_3_D_812370563_3_3_D_665036297==1 | D_812370563_4_4_D_812370563_4_4_D_665036297==1 ) ~ "Non-Hodgkin's Lymphoma", 
                                                     (D_812370563_1_1_D_812370563_1_1_D_200837530==1 | D_812370563_2_2_D_812370563_2_2_D_200837530==1 | D_812370563_3_3_D_812370563_3_3_D_200837530==1 | D_812370563_4_4_D_812370563_4_4_D_200837530==1 ) ~ "Lymphoma",
                                                     (D_812370563_1_1_D_812370563_1_1_D_990319383==1 | D_812370563_2_2_D_812370563_2_2_D_990319383==1 | D_812370563_3_3_D_812370563_3_3_D_990319383==1 | D_812370563_4_4_D_812370563_4_4_D_990319383==1) ~ "Melanoma Skin", 
                                                     (D_812370563_1_1_D_812370563_1_1_D_487917585==1 | D_812370563_2_2_D_812370563_2_2_D_487917585==1 | D_812370563_3_3_D_812370563_3_3_D_487917585==1 | D_812370563_4_4_D_812370563_4_4_D_487917585==1) ~ "Non-Melanoma Skin", 
                                                     (D_812370563_1_1_D_812370563_1_1_D_603181162==1 | D_812370563_2_2_D_812370563_2_2_D_603181162==1 | D_812370563_3_3_D_812370563_3_3_D_603181162==1  | D_812370563_4_4_D_812370563_4_4_D_603181162==1) ~ "Ovarian",
                                                     (D_812370563_1_1_D_812370563_1_1_D_482225200==1 | D_812370563_2_2_D_812370563_2_2_D_482225200==1 | D_812370563_3_3_D_812370563_3_3_D_482225200==1 | D_812370563_4_4_D_812370563_4_4_D_482225200==1) ~ "Pancreatic",
                                                     (D_812370563_1_1_D_812370563_1_1_D_295976386==1 | D_812370563_2_2_D_812370563_2_2_D_295976386==1 | D_812370563_3_3_D_812370563_3_3_D_295976386==1 | D_812370563_4_4_D_812370563_4_4_D_295976386==1) ~ "Prostate", 
                                                     (D_812370563_1_1_D_812370563_1_1_D_764891959==1 | D_812370563_2_2_D_812370563_2_2_D_764891959==1 | D_812370563_3_3_D_812370563_3_3_D_764891959==1 | D_812370563_4_4_D_812370563_4_4_D_764891959==1) ~ "Stomach",
                                                     (D_812370563_1_1_D_812370563_1_1_D_248374037==1 | D_812370563_2_2_D_812370563_2_2_D_248374037==1 | D_812370563_3_3_D_812370563_3_3_D_248374037==1 | D_812370563_4_4_D_812370563_4_4_D_248374037==1) ~ "Testicular",
                                                     (D_812370563_1_1_D_812370563_1_1_D_139822395==1 | D_812370563_2_2_D_812370563_2_2_D_139822395==1 | D_812370563_3_3_D_812370563_3_3_D_139822395==1  | D_812370563_4_4_D_812370563_4_4_D_139822395==1) ~ "Thyroid",
                                                     (D_812370563_1_1_D_812370563_1_1_D_723614811==1 | D_812370563_2_2_D_812370563_2_2_D_723614811==1 | D_812370563_3_3_D_812370563_3_3_D_723614811==1   | D_812370563_4_4_D_812370563_4_4_D_723614811==1) ~ "Uterine",
                                                     (D_812370563_1_1_D_812370563_1_1_D_807835037==1  | D_812370563_2_2_D_812370563_2_2_D_807835037==1  | D_812370563_3_3_D_812370563_3_3_D_807835037==1  | D_812370563_4_4_D_812370563_4_4_D_807835037==1   | !is.na(D_812370563_1_1_D_933110091_1) | !is.na(D_812370563_2_2_D_933110091_2) | !is.na(D_812370563_3_3_D_933110091_3)) ~ "Other", #| !is.na(D_812370563_4_4_D_933110091_4)
                                                     (D_812370563_1_1_D_812370563_1_1_D_178420302==1 | D_812370563_2_2_D_812370563_2_2_D_178420302==1 | D_812370563_3_3_D_812370563_3_3_D_178420302==1  | D_812370563_4_4_D_812370563_4_4_D_178420302==1) ~ "Unknown",
                                             TRUE ~ "Skipped this Question"))
                                 
dt_body_kid_summary <- body_kid %>% dplyr::group_by(bodyp) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(bodyp, percentage)  


kid_bd_canc <- dt_body_kid_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% 
  fmt_number(column = "bodyp", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("CHILDCAN2: Type of Cancer Children 1-4 Diagnosed With")) %>% 
  cols_label(bodyp = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = bodyp,
    )
  ) 

kid_bd_canc

```



## BSNSSTYP1 & BSNSSTYP2
```{r BuisType, warning=FALSE, echo=FALSE, message=FALSE}

dt_curr_bus= data_tib_base %>% filter(D_613744428=="353358909")

dt_curr_bus= dt_curr_bus  %>%  mutate(multb1 = ifelse(D_700374192_D_700374192_D_641572847==1, 1, 0) + ifelse(D_700374192_D_700374192_D_592592455==1, 1, 0) + ifelse(D_700374192_D_700374192_D_711138281==1, 1, 0) + ifelse(D_700374192_D_700374192_D_596792238==1, 1, 0) + ifelse(D_700374192_D_700374192_D_133362151==1, 1, 0) + ifelse(D_700374192_D_700374192_D_372993567==1, 1, 0) + ifelse(D_700374192_D_700374192_D_620577362==1, 1, 0) + ifelse(D_700374192_D_700374192_D_580409149==1, 1, 0) + ifelse(D_700374192_D_700374192_D_867237640==1, 1, 0) + ifelse(D_700374192_D_700374192_D_698814077==1, 1, 0) + ifelse(D_700374192_D_700374192_D_751475124==1, 1, 0) + ifelse(D_700374192_D_700374192_D_308286913==1, 1, 0) + ifelse(D_700374192_D_700374192_D_807835037==1, 1, 0) + ifelse(D_700374192_D_700374192_D_178420302==1, 1, 0))


bsn= dt_curr_bus  %>%  mutate(category= case_when(as.numeric(multb1)>1 ~ "Multiple Business Types",
                                                  D_700374192_D_700374192_D_641572847==1 ~ "Manufacturing",
                                             D_700374192_D_700374192_D_592592455==1 ~ "Retail or Wholesale Sales",
                                             D_700374192_D_700374192_D_711138281==1 | D_700374192_D_700374192_D_149230791 ==1 ~ "Transportation, warehousing, and utilities",
                                            D_700374192_D_700374192_D_596792238==1 | D_700374192_D_700374192_D_439857718==1 ~ "Professional and business services",
                                             D_700374192_D_700374192_D_133362151==1 ~ "Construction or Equipment Repair",
                                             D_700374192_D_700374192_D_372993567==1 ~ "Mining, quarrying, and oil annd gas extraction",
                                             D_700374192_D_700374192_D_709307391==1 ~ "Accommodation and food services",
                                             D_700374192_D_700374192_D_620577362==1 | D_700374192_D_700374192_D_580409149==1 |
                                              D_700374192_D_700374192_D_867237640==1 | D_700374192_D_700374192_D_927863729==1 ~ "Farming, fishing, or forestry",
                                             D_700374192_D_700374192_D_766533183==1 ~ "Healthcare or social assistance",
                                             D_700374192_D_700374192_D_698814077==1 ~ "Government",
                                             D_700374192_D_700374192_D_751475124==1 | D_700374192_D_700374192_D_942545134==1 ~ "Military, police, firefighting, security services",
                                             D_700374192_D_700374192_D_308286913==1 ~ "Shipyard",
                                             D_700374192_D_700374192_D_924908599==1 ~ "Education",
                                             D_700374192_D_700374192_D_868510850==1 ~ "Arts, entertainment, and recreation",
                                             (D_700374192_D_700374192_D_807835037==1 | !is.na(D_700374192_D_923333992)) ~ "Other", 
                                             D_700374192_D_700374192_D_178420302==1 ~ "Unknown",
                                             TRUE ~ "Skipped this question"))

dt_curr_bus_summary <- bsn %>% group_by(category) %>%   dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(category, n, percentage)

dt_curr_bus_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("BSNSSTYP1: Current Employer Business Type")) %>% 
  cols_label(n= md("**N**"), category = md("**Answer**"), percentage = md("**%**")) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = category,
    )
  ) 

```



```{r Business2, warning=FALSE, echo=FALSE, message=FALSE}

dt_curr_bus2= data_tib_base %>% filter(D_403258164==353358909 | D_847533056!=353358909)

dt_curr_bus2= dt_curr_bus2  %>%  mutate(multb2 = ifelse(D_530742915_D_530742915_D_641572847==1, 1, 0) + ifelse(D_530742915_D_530742915_D_592592455==1, 1, 0) + ifelse(D_530742915_D_530742915_D_711138281==1, 1, 0) + ifelse(D_530742915_D_530742915_D_596792238==1, 1, 0) + ifelse(D_530742915_D_530742915_D_133362151==1, 1, 0) + ifelse(D_530742915_D_530742915_D_372993567==1, 1, 0) + ifelse(D_530742915_D_530742915_D_620577362==1, 1, 0) + ifelse(D_530742915_D_530742915_D_580409149==1, 1, 0) + ifelse(D_530742915_D_530742915_D_867237640==1, 1, 0) + ifelse(D_530742915_D_530742915_D_698814077==1, 1, 0) + ifelse(D_530742915_D_530742915_D_751475124==1, 1, 0) + ifelse(D_530742915_D_530742915_D_308286913==1, 1, 0) + ifelse(D_530742915_D_530742915_D_807835037==1, 1, 0) + ifelse(D_530742915_D_530742915_D_178420302==1, 1, 0))


bsn= dt_curr_bus2  %>%  mutate(category= case_when(as.numeric(multb2)>1 ~ "Multiple Business Types",
                                                  D_530742915_D_530742915_D_641572847==1 ~ "Manufacturing",
                                             D_530742915_D_530742915_D_592592455==1 ~ "Retail or Wholesale Sales",
                                             D_530742915_D_530742915_D_711138281==1 | D_530742915_D_530742915_D_149230791 ==1 ~ "Transportation, warehousing, and utilities",
                                             #D_530742915_D_530742915_D_596792238==1 ~ "A Service Provider",
                                            D_530742915_D_530742915_D_596792238==1 | D_530742915_D_530742915_D_439857718==1 ~ "Professional and business services",
                                             D_530742915_D_530742915_D_133362151==1 ~ "Construction or Equipment Repair",
                                             D_530742915_D_530742915_D_372993567==1 ~ "Mining, quarrying, and oil annd gas extraction",
                                             D_530742915_D_530742915_D_709307391==1 ~ "Accommodation and food services",
                                             D_530742915_D_530742915_D_620577362==1 | D_530742915_D_530742915_D_580409149==1 |
                                              D_530742915_D_530742915_D_867237640==1 | D_530742915_D_530742915_D_927863729==1 ~ "Farming, fishing, or forestry",
                                             D_530742915_D_530742915_D_766533183==1 ~ "Healthcare or social assistance",
                                             D_530742915_D_530742915_D_698814077==1 ~ "Government",
                                             D_530742915_D_530742915_D_751475124==1 | D_530742915_D_530742915_D_942545134==1 ~ "Military, police, firefighting, security services",
                                             D_530742915_D_530742915_D_308286913==1 ~ "Shipyard",
                                             D_530742915_D_530742915_D_924908599==1 ~ "Education",
                                             D_530742915_D_530742915_D_868510850==1 ~ "Arts, entertainment, and recreation",
                                             (D_530742915_D_530742915_D_807835037==1 | !is.na(D_530742915_D_739237614)) ~ "Other", 
                                             D_530742915_D_530742915_D_178420302==1 ~ "Unknown",
                                            TRUE ~"Skipped this Question"))

dt_long_bus_summary <- bsn %>% group_by(category) %>%   dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(category, n, percentage)

#gt_dt_long_bus <- 
dt_long_bus_summary %>%  gt::gt(rowname_col = "row_lab") %>%  
  fmt_number(columns = "percentage", decimals = 2) %>% fmt_number(column = "n", decimals=0, use_seps = TRUE) %>% 
  tab_header(title = md("BSNSSTYP2: Employer Business Type for Longest Held Position")) %>% 
  cols_label(n= md("**N**"), category = md("**Answer**"), percentage = md("**%**")) %>% 
  #summary_rows(groups=F, fns = list(label = md("**ALL**"), id = "totals") ~ sum(.)) %>% 
  grand_summary_rows(columns=c(n, percentage),fns = ~sum(.,na.rm = T))|>
  tab_options(
      stub.font.weight = "bold"
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      columns = category,
    )
  ) 

#gt_dt_long_bus %>%   summary_rows(groups=T, column = c(n,percentage), fns = list(label = md("**ALL**"), id = "totals") ~ sum(.)) 
                                                
                                                  
```                                                  


